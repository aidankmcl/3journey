import{B as e,Ct as t,Dn as n,En as r,Ft as i,It as a,Kt as o,Lt as s,N as c,On as l,Rt as u,Sn as d,Xt as f,_t as p,b as m,bt as h,gt as g,h as _,i as v,j as y,m as b,n as x,nt as S,o as C,p as w,qt as ee,sn as te,tn as ne,u as re,vn as T,vt as ie,wt as ae,x as oe}from"../three.module-LFc9tN89.js";import"../modulepreload-polyfill-BnBYtx4y.js";import{t as se}from"../OrbitControls-D8EFuDj6.js";import{t as ce}from"../lil-gui.esm-DBlFozw-.js";import{t as le}from"../three-custom-shader-material.es-B2ErjGFs.js";const ue=1.25,de=65535,fe=2**-24,pe=Symbol(`SKIP_GENERATION`);function me(e){return e.index?e.index.count:e.attributes.position.count}function he(e){return me(e)/3}function ge(e,t=ArrayBuffer){return e>65535?new Uint32Array(new t(4*e)):new Uint16Array(new t(2*e))}function _e(e,t){if(!e.index){let n=e.attributes.position.count,r=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=ge(n,r);e.setIndex(new _(i,1));for(let e=0;e<n;e++)i[e]=e}}function ve(e,t){let n=he(e),r=t||e.drawRange,i=r.start/3,a=(r.start+r.count)/3,o=Math.max(0,i),s=Math.min(n,a)-o;return[{offset:Math.floor(o),count:Math.floor(s)}]}function ye(e,t){if(!e.groups||!e.groups.length)return ve(e,t);let n=[],r=new Set,i=t||e.drawRange,a=i.start/3,o=(i.start+i.count)/3;for(let t of e.groups){let e=t.start/3,n=(t.start+t.count)/3;r.add(Math.max(a,e)),r.add(Math.min(o,n))}let s=Array.from(r.values()).sort((e,t)=>e-t);for(let e=0;e<s.length-1;e++){let t=s[e],r=s[e+1];n.push({offset:Math.floor(t),count:Math.floor(r-t)})}return n}function be(e,t){let n=he(e),r=ye(e,t).sort((e,t)=>e.offset-t.offset),i=r[r.length-1];i.count=Math.min(n-i.offset,i.count);let a=0;return r.forEach(({count:e})=>a+=e),n!==a}function xe(e,t,n,r,i){let a=1/0,o=1/0,s=1/0,c=-1/0,l=-1/0,u=-1/0,d=1/0,f=1/0,p=1/0,m=-1/0,h=-1/0,g=-1/0;for(let r=t*6,i=(t+n)*6;r<i;r+=6){let t=e[r+0],n=e[r+1],i=t-n,_=t+n;i<a&&(a=i),_>c&&(c=_),t<d&&(d=t),t>m&&(m=t);let v=e[r+2],y=e[r+3],b=v-y,x=v+y;b<o&&(o=b),x>l&&(l=x),v<f&&(f=v),v>h&&(h=v);let S=e[r+4],C=e[r+5],w=S-C,ee=S+C;w<s&&(s=w),ee>u&&(u=ee),S<p&&(p=S),S>g&&(g=S)}r[0]=a,r[1]=o,r[2]=s,r[3]=c,r[4]=l,r[5]=u,i[0]=d,i[1]=f,i[2]=p,i[3]=m,i[4]=h,i[5]=g}function Se(e,t=null,n=null,r=null){let i=e.attributes.position,a=e.index?e.index.array:null,o=he(e),s=i.normalized,c;t===null?(c=new Float32Array(o*6),n=0,r=o):(c=t,n||=0,r||=o);let l=i.array,u=i.offset||0,d=3;i.isInterleavedBufferAttribute&&(d=i.data.stride);let f=[`getX`,`getY`,`getZ`];for(let e=n;e<n+r;e++){let t=e*3,n=e*6,r=t+0,o=t+1,p=t+2;a&&(r=a[r],o=a[o],p=a[p]),s||(r=r*d+u,o=o*d+u,p=p*d+u);for(let e=0;e<3;e++){let t,a,u;s?(t=i[f[e]](r),a=i[f[e]](o),u=i[f[e]](p)):(t=l[r+e],a=l[o+e],u=l[p+e]);let d=t;a<d&&(d=a),u<d&&(d=u);let m=t;a>m&&(m=a),u>m&&(m=u);let h=(m-d)/2,g=e*2;c[n+g+0]=d+h,c[n+g+1]=h+(Math.abs(d)+h)*fe}}return c}function E(e,t,n){return n.min.x=t[e],n.min.y=t[e+1],n.min.z=t[e+2],n.max.x=t[e+3],n.max.y=t[e+4],n.max.z=t[e+5],n}function Ce(e){let t=-1,n=-1/0;for(let r=0;r<3;r++){let i=e[r+3]-e[r];i>n&&(n=i,t=r)}return t}function we(e,t){t.set(e)}function Te(e,t,n){let r,i;for(let a=0;a<3;a++){let o=a+3;r=e[a],i=t[a],n[a]=r<i?r:i,r=e[o],i=t[o],n[o]=r>i?r:i}}function Ee(e,t,n){for(let r=0;r<3;r++){let i=t[e+2*r],a=t[e+2*r+1],o=i-a,s=i+a;o<n[r]&&(n[r]=o),s>n[r+3]&&(n[r+3]=s)}}function De(e){let t=e[3]-e[0],n=e[4]-e[1],r=e[5]-e[2];return 2*(t*n+n*r+r*t)}var D=32,Oe=(e,t)=>e.candidate-t.candidate,ke=Array(D).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Ae=new Float32Array(6);function je(e,t,n,r,i,a){let o=-1,s=0;if(a===0)o=Ce(t),o!==-1&&(s=(t[o]+t[o+3])/2);else if(a===1)o=Ce(e),o!==-1&&(s=Me(n,r,i,o));else if(a===2){let a=De(e),c=ue*i,l=r*6,u=(r+i)*6;for(let e=0;e<3;e++){let r=t[e],d=(t[e+3]-r)/D;if(i<D/4){let t=[...ke];t.length=i;let r=0;for(let i=l;i<u;i+=6,r++){let a=t[r];a.candidate=n[i+2*e],a.count=0;let{bounds:o,leftCacheBounds:s,rightCacheBounds:c}=a;for(let e=0;e<3;e++)c[e]=1/0,c[e+3]=-1/0,s[e]=1/0,s[e+3]=-1/0,o[e]=1/0,o[e+3]=-1/0;Ee(i,n,o)}t.sort(Oe);let d=i;for(let e=0;e<d;e++){let n=t[e];for(;e+1<d&&t[e+1].candidate===n.candidate;)t.splice(e+1,1),d--}for(let r=l;r<u;r+=6){let i=n[r+2*e];for(let e=0;e<d;e++){let a=t[e];i>=a.candidate?Ee(r,n,a.rightCacheBounds):(Ee(r,n,a.leftCacheBounds),a.count++)}}for(let n=0;n<d;n++){let r=t[n],l=r.count,u=i-r.count,d=r.leftCacheBounds,f=r.rightCacheBounds,p=0;l!==0&&(p=De(d)/a);let m=0;u!==0&&(m=De(f)/a);let h=1+ue*(p*l+m*u);h<c&&(o=e,c=h,s=r.candidate)}}else{for(let e=0;e<D;e++){let t=ke[e];t.count=0,t.candidate=r+d+e*d;let n=t.bounds;for(let e=0;e<3;e++)n[e]=1/0,n[e+3]=-1/0}for(let t=l;t<u;t+=6){let i=~~((n[t+2*e]-r)/d);i>=D&&(i=D-1);let a=ke[i];a.count++,Ee(t,n,a.bounds)}let t=ke[D-1];we(t.bounds,t.rightCacheBounds);for(let e=D-2;e>=0;e--){let t=ke[e],n=ke[e+1];Te(t.bounds,n.rightCacheBounds,t.rightCacheBounds)}let f=0;for(let t=0;t<D-1;t++){let n=ke[t],r=n.count,l=n.bounds,u=ke[t+1].rightCacheBounds;r!==0&&(f===0?we(l,Ae):Te(l,Ae,Ae)),f+=r;let d=0,p=0;f!==0&&(d=De(Ae)/a);let m=i-f;m!==0&&(p=De(u)/a);let h=1+ue*(d*f+p*m);h<c&&(o=e,c=h,s=n.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${a} used.`);return{axis:o,pos:s}}function Me(e,t,n,r){let i=0;for(let a=t,o=t+n;a<o;a++)i+=e[a*6+r*2];return i/n}var Ne=class{constructor(){this.boundingData=new Float32Array(6)}};function Pe(e,t,n,r,i,a){let o=r,s=r+i-1,c=a.pos,l=a.axis*2;for(;;){for(;o<=s&&n[o*6+l]<c;)o++;for(;o<=s&&n[s*6+l]>=c;)s--;if(o<s){for(let e=0;e<3;e++){let n=t[o*3+e];t[o*3+e]=t[s*3+e],t[s*3+e]=n}for(let e=0;e<6;e++){let t=n[o*6+e];n[o*6+e]=n[s*6+e],n[s*6+e]=t}o++,s--}else return o}}function Fe(e,t,n,r,i,a){let o=r,s=r+i-1,c=a.pos,l=a.axis*2;for(;;){for(;o<=s&&n[o*6+l]<c;)o++;for(;o<=s&&n[s*6+l]>=c;)s--;if(o<s){let t=e[o];e[o]=e[s],e[s]=t;for(let e=0;e<6;e++){let t=n[o*6+e];n[o*6+e]=n[s*6+e],n[s*6+e]=t}o++,s--}else return o}}function O(e,t){return t[e+15]===65535}function k(e,t){return t[e+6]}function A(e,t){return t[e+14]}function j(e){return e+8}function M(e,t){return t[e+6]}function Ie(e,t){return t[e+7]}function N(e){return e}var Le,Re,ze,Be,Ve=2**32;function He(e){return`count`in e?1:1+He(e.left)+He(e.right)}function Ue(e,t,n){return Le=new Float32Array(n),Re=new Uint32Array(n),ze=new Uint16Array(n),Be=new Uint8Array(n),We(e,t)}function We(e,t){let n=e/4,r=e/2,i=`count`in t,a=t.boundingData;for(let e=0;e<6;e++)Le[n+e]=a[e];if(i)if(t.buffer){let r=t.buffer;Be.set(new Uint8Array(r),e);for(let t=e,i=e+r.byteLength;t<i;t+=32){let e=t/2;O(e,ze)||(Re[t/4+6]+=n)}return e+r.byteLength}else{let i=t.offset,a=t.count;return Re[n+6]=i,ze[r+14]=a,ze[r+15]=de,e+32}else{let r=t.left,i=t.right,a=t.splitAxis,o;if(o=We(e+32,r),o/4>Ve)throw Error(`MeshBVH: Cannot store child pointer greater than 32 bits.`);return Re[n+6]=o/4,o=We(o,i),Re[n+7]=a,o}}function Ge(e,t){let n=(e.index?e.index.count:e.attributes.position.count)/3,r=n>2**16,i=r?4:2,a=t?new SharedArrayBuffer(n*i):new ArrayBuffer(n*i),o=r?new Uint32Array(a):new Uint16Array(a);for(let e=0,t=o.length;e<t;e++)o[e]=e;return o}function Ke(e,t,n,r,i){let{maxDepth:a,verbose:o,maxLeafTris:s,strategy:c,onProgress:l,indirect:u}=i,d=e._indirectBuffer,f=e.geometry,p=f.index?f.index.array:null,m=u?Fe:Pe,h=he(f),g=new Float32Array(6),_=!1,v=new Ne;return xe(t,n,r,v.boundingData,g),b(v,n,r,g),v;function y(e){l&&l(e/h)}function b(e,n,r,i=null,l=0){if(!_&&l>=a&&(_=!0,o&&(console.warn(`MeshBVH: Max depth of ${a} reached when generating BVH. Consider increasing maxDepth.`),console.warn(f))),r<=s||l>=a)return y(n+r),e.offset=n,e.count=r,e;let u=je(e.boundingData,i,t,n,r,c);if(u.axis===-1)return y(n+r),e.offset=n,e.count=r,e;let h=m(d,p,t,n,r,u);if(h===n||h===n+r)y(n+r),e.offset=n,e.count=r;else{e.splitAxis=u.axis;let i=new Ne,a=n,o=h-n;e.left=i,xe(t,a,o,i.boundingData,g),b(i,a,o,g,l+1);let s=new Ne,c=h,d=r-o;e.right=s,xe(t,c,d,s.boundingData,g),b(s,c,d,g,l+1)}return e}}function qe(e,t){let n=e.geometry;t.indirect&&(e._indirectBuffer=Ge(n,t.useSharedArrayBuffer),be(n,t.range)&&!t.verbose&&console.warn(`MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.`)),e._indirectBuffer||_e(n,t);let r=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=Se(n);e._roots=(t.indirect?ve(n,t.range):ye(n,t.range)).map(n=>{let a=Ke(e,i,n.offset,n.count,t),o=He(a),s=new r(32*o);return Ue(0,a,s),s})}var P=class{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let n=1/0,r=-1/0;for(let i=0,a=e.length;i<a;i++){let a=e[i][t];n=a<n?a:n,r=a>r?a:r}this.min=n,this.max=r}setFromPoints(e,t){let n=1/0,r=-1/0;for(let i=0,a=t.length;i<a;i++){let a=t[i],o=e.dot(a);n=o<n?o:n,r=o>r?o:r}this.min=n,this.max=r}isSeparated(e){return this.min>e.max||e.min>this.max}};P.prototype.setFromBox=(function(){let e=new n;return function(t,n){let r=n.min,i=n.max,a=1/0,o=-1/0;for(let n=0;n<=1;n++)for(let s=0;s<=1;s++)for(let c=0;c<=1;c++){e.x=r.x*n+i.x*(1-n),e.y=r.y*s+i.y*(1-s),e.z=r.z*c+i.z*(1-c);let l=t.dot(e);a=Math.min(l,a),o=Math.max(l,o)}this.min=a,this.max=o}})(),(function(){let e=new P;return function(t,n){let r=t.points,i=t.satAxes,a=t.satBounds,o=n.points,s=n.satAxes,c=n.satBounds;for(let t=0;t<3;t++){let n=a[t],r=i[t];if(e.setFromPoints(r,o),n.isSeparated(e))return!1}for(let t=0;t<3;t++){let n=c[t],i=s[t];if(e.setFromPoints(i,r),n.isSeparated(e))return!1}}})();const Je=(function(){let e=new n,t=new n,r=new n;return function(n,i,a){let o=n.start,s=e,c=i.start,l=t;r.subVectors(o,c),e.subVectors(n.end,n.start),t.subVectors(i.end,i.start);let u=r.dot(l),d=l.dot(s),f=l.dot(l),p=r.dot(s),m=s.dot(s)*f-d*d,h,g;h=m===0?0:(u*d-p*f)/m,g=(u+h*d)/f,a.x=h,a.y=g}})(),Ye=(function(){let e=new r,t=new n,i=new n;return function(n,r,a,o){Je(n,r,e);let s=e.x,c=e.y;if(s>=0&&s<=1&&c>=0&&c<=1){n.at(s,a),r.at(c,o);return}else if(s>=0&&s<=1){c<0?r.at(0,o):r.at(1,o),n.closestPointToPoint(o,!0,a);return}else if(c>=0&&c<=1){s<0?n.at(0,a):n.at(1,a),r.closestPointToPoint(a,!0,o);return}else{let e;e=s<0?n.start:n.end;let l;l=c<0?r.start:r.end;let u=t,d=i;if(n.closestPointToPoint(l,!0,t),r.closestPointToPoint(e,!0,i),u.distanceToSquared(l)<=d.distanceToSquared(e)){a.copy(u),o.copy(l);return}else{a.copy(e),o.copy(d);return}}}})(),Xe=(function(){let e=new n,t=new n,r=new s,i=new S;return function(n,a){let{radius:o,center:s}=n,{a:c,b:l,c:u}=a;if(i.start=c,i.end=l,i.closestPointToPoint(s,!0,e).distanceTo(s)<=o||(i.start=c,i.end=u,i.closestPointToPoint(s,!0,e).distanceTo(s)<=o)||(i.start=l,i.end=u,i.closestPointToPoint(s,!0,e).distanceTo(s)<=o))return!0;let d=a.getPlane(r);if(Math.abs(d.distanceToPoint(s))<=o){let e=d.projectPoint(s,t);if(a.containsPoint(e))return!0}return!1}})();var Ze=1e-15;function Qe(e){return Math.abs(e)<Ze}var F=class extends T{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=[,,,,].fill().map(()=>new n),this.satBounds=[,,,,].fill().map(()=>new P),this.points=[this.a,this.b,this.c],this.sphere=new te,this.plane=new s,this.needsUpdate=!0}intersectsSphere(e){return Xe(e,this)}update(){let e=this.a,t=this.b,n=this.c,r=this.points,i=this.satAxes,a=this.satBounds,o=i[0],s=a[0];this.getNormal(o),s.setFromPoints(o,r);let c=i[1],l=a[1];c.subVectors(e,t),l.setFromPoints(c,r);let u=i[2],d=a[2];u.subVectors(t,n),d.setFromPoints(u,r);let f=i[3],p=a[3];f.subVectors(n,e),p.setFromPoints(f,r),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,e),this.needsUpdate=!1}};F.prototype.closestPointToSegment=(function(){let e=new n,t=new n,r=new S;return function(n,i=null,a=null){let{start:o,end:s}=n,c=this.points,l,u=1/0;for(let o=0;o<3;o++){let s=(o+1)%3;r.start.copy(c[o]),r.end.copy(c[s]),Ye(r,n,e,t),l=e.distanceToSquared(t),l<u&&(u=l,i&&i.copy(e),a&&a.copy(t))}return this.closestPointToPoint(o,e),l=o.distanceToSquared(e),l<u&&(u=l,i&&i.copy(e),a&&a.copy(o)),this.closestPointToPoint(s,e),l=s.distanceToSquared(e),l<u&&(u=l,i&&i.copy(e),a&&a.copy(s)),Math.sqrt(u)}})(),F.prototype.intersectsTriangle=(function(){let e=new F,t=[,,,],r=[,,,],i=new P,a=new P,o=new n,s=new n,c=new n,l=new n,u=new n,d=new S,f=new S,p=new S,m=new n;function h(e,t,n){let r=e.points,i=0,a=-1;for(let e=0;e<3;e++){let{start:o,end:c}=d;o.copy(r[e]),c.copy(r[(e+1)%3]),d.delta(s);let l=Qe(t.distanceToPoint(o));if(Qe(t.normal.dot(s))&&l){n.copy(d),i=2;break}let u=t.intersectLine(d,m);if(!u&&l&&m.copy(o),(u||l)&&!Qe(m.distanceTo(c))){if(i<=1)(i===1?n.start:n.end).copy(m),l&&(a=i);else if(i>=2){(a===1?n.start:n.end).copy(m),i=2;break}if(i++,i===2&&a===-1)break}}return i}return function(n,s=null,d=!1){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(e.copy(n),e.update(),n=e);let m=this.plane,g=n.plane;if(Math.abs(m.normal.dot(g.normal))>.9999999999){let e=this.satBounds,c=this.satAxes;r[0]=n.a,r[1]=n.b,r[2]=n.c;for(let t=0;t<4;t++){let n=e[t],a=c[t];if(i.setFromPoints(a,r),n.isSeparated(i))return!1}let l=n.satBounds,u=n.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let e=0;e<4;e++){let n=l[e],r=u[e];if(i.setFromPoints(r,t),n.isSeparated(i))return!1}for(let e=0;e<4;e++){let n=c[e];for(let e=0;e<4;e++){let s=u[e];if(o.crossVectors(n,s),i.setFromPoints(o,t),a.setFromPoints(o,r),i.isSeparated(a))return!1}}return s&&(d||console.warn(`ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0.`),s.start.set(0,0,0),s.end.set(0,0,0)),!0}else{let e=h(this,g,f);if(e===1&&n.containsPoint(f.end))return s&&(s.start.copy(f.end),s.end.copy(f.end)),!0;if(e!==2)return!1;let t=h(n,m,p);if(t===1&&this.containsPoint(p.end))return s&&(s.start.copy(p.end),s.end.copy(p.end)),!0;if(t!==2)return!1;if(f.delta(c),p.delta(l),c.dot(l)<0){let e=p.start;p.start=p.end,p.end=e}let r=f.start.dot(c),i=f.end.dot(c),a=p.start.dot(c),o=p.end.dot(c);return r!==o&&a!==i&&i<a==r<o?!1:(s&&(u.subVectors(f.start,p.start),u.dot(c)>0?s.start.copy(f.start):s.start.copy(p.start),u.subVectors(f.end,p.end),u.dot(c)<0?s.end.copy(f.end):s.end.copy(p.end)),!0)}}})(),F.prototype.distanceToPoint=(function(){let e=new n;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}})(),F.prototype.distanceToTriangle=(function(){let e=new n,t=new n,r=[`a`,`b`,`c`],i=new S,a=new S;return function(n,o=null,s=null){let c=o||s?i:null;if(this.intersectsTriangle(n,c))return(o||s)&&(o&&c.getCenter(o),s&&c.getCenter(s)),0;let l=1/0;for(let t=0;t<3;t++){let i,a=r[t],c=n[a];this.closestPointToPoint(c,e),i=c.distanceToSquared(e),i<l&&(l=i,o&&o.copy(e),s&&s.copy(c));let u=this[a];n.closestPointToPoint(u,e),i=u.distanceToSquared(e),i<l&&(l=i,o&&o.copy(u),s&&s.copy(e))}for(let c=0;c<3;c++){let u=r[c],d=r[(c+1)%3];i.set(this[u],this[d]);for(let c=0;c<3;c++){let u=r[c],d=r[(c+1)%3];a.set(n[u],n[d]),Ye(i,a,e,t);let f=e.distanceToSquared(t);f<l&&(l=f,o&&o.copy(e),s&&s.copy(t))}}return Math.sqrt(l)}})();var I=class{constructor(e,t,r){this.isOrientedBox=!0,this.min=new n,this.max=new n,this.matrix=new p,this.invMatrix=new p,this.points=Array(8).fill().map(()=>new n),this.satAxes=[,,,].fill().map(()=>new n),this.satBounds=[,,,].fill().map(()=>new P),this.alignedSatBounds=[,,,].fill().map(()=>new P),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),r&&this.matrix.copy(r)}set(e,t,n){this.min.copy(e),this.max.copy(t),this.matrix.copy(n),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}};I.prototype.update=(function(){return function(){let e=this.matrix,t=this.min,n=this.max,r=this.points;for(let i=0;i<=1;i++)for(let a=0;a<=1;a++)for(let o=0;o<=1;o++){let s=1*i|2*a|4*o,c=r[s];c.x=i?n.x:t.x,c.y=a?n.y:t.y,c.z=o?n.z:t.z,c.applyMatrix4(e)}let i=this.satBounds,a=this.satAxes,o=r[0];for(let e=0;e<3;e++){let t=a[e],n=i[e],s=1<<e,c=r[s];t.subVectors(o,c),n.setFromPoints(t,r)}let s=this.alignedSatBounds;s[0].setFromPointsField(r,`x`),s[1].setFromPointsField(r,`y`),s[2].setFromPointsField(r,`z`),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})(),I.prototype.intersectsBox=(function(){let e=new P;return function(t){this.needsUpdate&&this.update();let n=t.min,r=t.max,i=this.satBounds,a=this.satAxes,o=this.alignedSatBounds;if(e.min=n.x,e.max=r.x,o[0].isSeparated(e)||(e.min=n.y,e.max=r.y,o[1].isSeparated(e))||(e.min=n.z,e.max=r.z,o[2].isSeparated(e)))return!1;for(let n=0;n<3;n++){let r=a[n],o=i[n];if(e.setFromBox(r,t),o.isSeparated(e))return!1}return!0}})(),I.prototype.intersectsTriangle=(function(){let e=new F,t=[,,,],r=new P,i=new P,a=new n;return function(n){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(e.copy(n),e.update(),n=e);let o=this.satBounds,s=this.satAxes;t[0]=n.a,t[1]=n.b,t[2]=n.c;for(let e=0;e<3;e++){let n=o[e],i=s[e];if(r.setFromPoints(i,t),n.isSeparated(r))return!1}let c=n.satBounds,l=n.satAxes,u=this.points;for(let e=0;e<3;e++){let t=c[e],n=l[e];if(r.setFromPoints(n,u),t.isSeparated(r))return!1}for(let e=0;e<3;e++){let n=s[e];for(let e=0;e<4;e++){let o=l[e];if(a.crossVectors(n,o),r.setFromPoints(a,t),i.setFromPoints(a,u),r.isSeparated(i))return!1}}return!0}})(),I.prototype.closestPointToPoint=(function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}})(),I.prototype.distanceToPoint=(function(){let e=new n;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}})(),I.prototype.distanceToBox=(function(){let e=[`x`,`y`,`z`],t=Array(12).fill().map(()=>new S),r=Array(12).fill().map(()=>new S),i=new n,a=new n;return function(n,o=0,s=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(n))return(s||c)&&(n.getCenter(a),this.closestPointToPoint(a,i),n.closestPointToPoint(i,a),s&&s.copy(i),c&&c.copy(a)),0;let l=o*o,u=n.min,d=n.max,f=this.points,p=1/0;for(let e=0;e<8;e++){let t=f[e];a.copy(t).clamp(u,d);let n=t.distanceToSquared(a);if(n<p&&(p=n,s&&s.copy(t),c&&c.copy(a),n<l))return Math.sqrt(n)}let m=0;for(let n=0;n<3;n++)for(let i=0;i<=1;i++)for(let a=0;a<=1;a++){let o=(n+1)%3,s=(n+2)%3,c=i<<o|a<<s,l=1<<n|i<<o|a<<s,p=f[c],h=f[l];t[m].set(p,h);let g=e[n],_=e[o],v=e[s],y=r[m],b=y.start,x=y.end;b[g]=u[g],b[_]=i?u[_]:d[_],b[v]=a?u[v]:d[_],x[g]=d[g],x[_]=i?u[_]:d[_],x[v]=a?u[v]:d[_],m++}for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)for(let n=0;n<=1;n++){a.x=e?d.x:u.x,a.y=t?d.y:u.y,a.z=n?d.z:u.z,this.closestPointToPoint(a,i);let r=a.distanceToSquared(i);if(r<p&&(p=r,s&&s.copy(i),c&&c.copy(a),r<l))return Math.sqrt(r)}for(let e=0;e<12;e++){let n=t[e];for(let e=0;e<12;e++){let t=r[e];Ye(n,t,i,a);let o=i.distanceToSquared(a);if(o<p&&(p=o,s&&s.copy(i),c&&c.copy(a),o<l))return Math.sqrt(o)}}return Math.sqrt(p)}})();var $e=class{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){let e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}};const L=new class extends $e{constructor(){super(()=>new F)}},R=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;let e=[],t=null;this.setBuffer=n=>{t&&e.push(t),t=n,this.float32Array=new Float32Array(n),this.uint16Array=new Uint16Array(n),this.uint32Array=new Uint32Array(n)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}};var et,tt,nt=[],rt=new $e(()=>new w);function it(e,t,n,r,i,a){et=rt.getPrimitive(),tt=rt.getPrimitive(),nt.push(et,tt),R.setBuffer(e._roots[t]);let o=at(0,e.geometry,n,r,i,a);R.clearBuffer(),rt.releasePrimitive(et),rt.releasePrimitive(tt),nt.pop(),nt.pop();let s=nt.length;return s>0&&(tt=nt[s-1],et=nt[s-2]),o}function at(e,t,n,r,i=null,a=0,o=0){let{float32Array:s,uint16Array:c,uint32Array:l}=R,u=e*2;if(O(u,c)){let t=k(e,l),n=A(u,c);return E(N(e),s,et),r(t,n,!1,o,a+e,et)}else{let u=j(e),d=M(e,l),f=u,p=d,m,h,g,_;if(i&&(g=et,_=tt,E(N(f),s,g),E(N(p),s,_),m=i(g),h=i(_),h<m)){f=d,p=u;let e=m;m=h,h=e,g=_}g||(g=et,E(N(f),s,g));let v=O(f*2,c),y=n(g,v,m,o+1,a+f),b;if(y===2){let e=w(f),t=ee(f)-e;b=r(e,t,!0,o+1,a+f,g)}else b=y&&at(f,t,n,r,i,a,o+1);if(b)return!0;_=tt,E(N(p),s,_);let x=O(p*2,c),S=n(_,x,h,o+1,a+p),C;if(S===2){let e=w(p),t=ee(p)-e;C=r(e,t,!0,o+1,a+p,_)}else C=S&&at(p,t,n,r,i,a,o+1);if(C)return!0;return!1;function w(e){let{uint16Array:t,uint32Array:n}=R,r=e*2;for(;!O(r,t);)e=j(e),r=e*2;return k(e,n)}function ee(e){let{uint16Array:t,uint32Array:n}=R,r=e*2;for(;!O(r,t);)e=M(e,n),r=e*2;return k(e,n)+A(r,t)}}}var ot=new n,st=new n;function ct(e,t,n={},r=0,i=1/0){let a=r*r,o=i*i,s=1/0,c=null;if(e.shapecast({boundsTraverseOrder:e=>(ot.copy(t).clamp(e.min,e.max),ot.distanceToSquared(t)),intersectsBounds:(e,t,n)=>n<s&&n<o,intersectsTriangle:(e,n)=>{e.closestPointToPoint(t,ot);let r=t.distanceToSquared(ot);return r<s&&(st.copy(ot),s=r,c=n),r<a}}),s===1/0)return null;let l=Math.sqrt(s);return n.point?n.point.copy(st):n.point=st.clone(),n.distance=l,n.faceIndex=c,n}var lt=!0,ut=new n,dt=new n,ft=new n,pt=new r,mt=new r,ht=new r,gt=new n,_t=new n,vt=new n,yt=new n;function bt(e,t,n,r,i,a,o,s){let c;if(c=a===1?e.intersectTriangle(r,n,t,!0,i):e.intersectTriangle(t,n,r,a!==2,i),c===null)return null;let l=e.origin.distanceTo(i);return l<o||l>s?null:{distance:l,point:i.clone()}}function xt(e,t,i,a,o,s,c,l,u,d,f){ut.fromBufferAttribute(t,s),dt.fromBufferAttribute(t,c),ft.fromBufferAttribute(t,l);let p=bt(e,ut,dt,ft,yt,u,d,f);if(p){let t=new n;T.getBarycoord(yt,ut,dt,ft,t),a&&(pt.fromBufferAttribute(a,s),mt.fromBufferAttribute(a,c),ht.fromBufferAttribute(a,l),p.uv=T.getInterpolation(yt,ut,dt,ft,pt,mt,ht,new r)),o&&(pt.fromBufferAttribute(o,s),mt.fromBufferAttribute(o,c),ht.fromBufferAttribute(o,l),p.uv1=T.getInterpolation(yt,ut,dt,ft,pt,mt,ht,new r)),i&&(gt.fromBufferAttribute(i,s),_t.fromBufferAttribute(i,c),vt.fromBufferAttribute(i,l),p.normal=T.getInterpolation(yt,ut,dt,ft,gt,_t,vt,new n),p.normal.dot(e.direction)>0&&p.normal.multiplyScalar(-1));let u={a:s,b:c,c:l,normal:new n,materialIndex:0};T.getNormal(ut,dt,ft,u.normal),p.face=u,p.faceIndex=s,lt&&(p.barycoord=t)}return p}function St(e,t,n,r,i,a,o){let s=r*3,c=s+0,l=s+1,u=s+2,d=e.index;e.index&&(c=d.getX(c),l=d.getX(l),u=d.getX(u));let{position:f,normal:p,uv:m,uv1:h}=e.attributes,g=xt(n,f,p,m,h,c,l,u,t,a,o);return g?(g.faceIndex=r,i&&i.push(g),g):null}function z(e,t,n,r){let i=e.a,a=e.b,o=e.c,s=t,c=t+1,l=t+2;n&&(s=n.getX(s),c=n.getX(c),l=n.getX(l)),i.x=r.getX(s),i.y=r.getY(s),i.z=r.getZ(s),a.x=r.getX(c),a.y=r.getY(c),a.z=r.getZ(c),o.x=r.getX(l),o.y=r.getY(l),o.z=r.getZ(l)}function Ct(e,t,n,r,i,a,o,s){let{geometry:c,_indirectBuffer:l}=e;for(let e=r,l=r+i;e<l;e++)St(c,t,n,e,a,o,s)}function wt(e,t,n,r,i,a,o){let{geometry:s,_indirectBuffer:c}=e,l=1/0,u=null;for(let e=r,c=r+i;e<c;e++){let r;r=St(s,t,n,e,null,a,o),r&&r.distance<l&&(u=r,l=r.distance)}return u}function Tt(e,t,n,r,i,a,o){let{geometry:s}=n,{index:c}=s,l=s.attributes.position;for(let n=e,s=t+e;n<s;n++){let e;if(e=n,z(o,e*3,c,l),o.needsUpdate=!0,r(o,e,i,a))return!0}return!1}function Et(e,t=null){t&&Array.isArray(t)&&(t=new Set(t));let n=e.geometry,r=n.index?n.index.array:null,i=n.attributes.position,a,o,s,c,l=0,u=e._roots;for(let e=0,t=u.length;e<t;e++)a=u[e],o=new Uint32Array(a),s=new Uint16Array(a),c=new Float32Array(a),d(0,l),l+=a.byteLength;function d(e,n,a=!1){let l=e*2;if(s[l+15]===65535){let t=o[e+6],n=s[l+14],a=1/0,u=1/0,d=1/0,f=-1/0,p=-1/0,m=-1/0;for(let e=3*t,o=3*(t+n);e<o;e++){let t=r[e],n=i.getX(t),o=i.getY(t),s=i.getZ(t);n<a&&(a=n),n>f&&(f=n),o<u&&(u=o),o>p&&(p=o),s<d&&(d=s),s>m&&(m=s)}return c[e+0]!==a||c[e+1]!==u||c[e+2]!==d||c[e+3]!==f||c[e+4]!==p||c[e+5]!==m?(c[e+0]=a,c[e+1]=u,c[e+2]=d,c[e+3]=f,c[e+4]=p,c[e+5]=m,!0):!1}else{let r=e+8,i=o[e+6],s=r+n,l=i+n,u=a,f=!1,p=!1;t?u||=(f=t.has(s),p=t.has(l),!f&&!p):(f=!0,p=!0);let m=u||f,h=u||p,g=!1;m&&(g=d(r,n,u));let _=!1;h&&(_=d(i,n,u));let v=g||_;if(v)for(let t=0;t<3;t++){let n=r+t,a=i+t,o=c[n],s=c[n+3],l=c[a],u=c[a+3];c[e+t]=o<l?o:l,c[e+t+3]=s>u?s:u}return v}}}function Dt(e,t,n,r,i){let a,o,s,c,l,u,d=1/n.direction.x,f=1/n.direction.y,p=1/n.direction.z,m=n.origin.x,h=n.origin.y,g=n.origin.z,_=t[e],v=t[e+3],y=t[e+1],b=t[e+3+1],x=t[e+2],S=t[e+3+2];return d>=0?(a=(_-m)*d,o=(v-m)*d):(a=(v-m)*d,o=(_-m)*d),f>=0?(s=(y-h)*f,c=(b-h)*f):(s=(b-h)*f,c=(y-h)*f),a>c||s>o||((s>a||isNaN(a))&&(a=s),(c<o||isNaN(o))&&(o=c),p>=0?(l=(x-g)*p,u=(S-g)*p):(l=(S-g)*p,u=(x-g)*p),a>u||l>o)?!1:((l>a||a!==a)&&(a=l),(u<o||o!==o)&&(o=u),a<=i&&o>=r)}function Ot(e,t,n,r,i,a,o,s){let{geometry:c,_indirectBuffer:l}=e;for(let e=r,u=r+i;e<u;e++){let r=l?l[e]:e;St(c,t,n,r,a,o,s)}}function kt(e,t,n,r,i,a,o){let{geometry:s,_indirectBuffer:c}=e,l=1/0,u=null;for(let e=r,d=r+i;e<d;e++){let r;r=St(s,t,n,c?c[e]:e,null,a,o),r&&r.distance<l&&(u=r,l=r.distance)}return u}function At(e,t,n,r,i,a,o){let{geometry:s}=n,{index:c}=s,l=s.attributes.position;for(let s=e,u=t+e;s<u;s++){let e;if(e=n.resolveTriangleIndex(s),z(o,e*3,c,l),o.needsUpdate=!0,r(o,e,i,a))return!0}return!1}function jt(e,t,n,r,i,a,o){R.setBuffer(e._roots[t]),Mt(0,e,n,r,i,a,o),R.clearBuffer()}function Mt(e,t,n,r,i,a,o){let{float32Array:s,uint16Array:c,uint32Array:l}=R,u=e*2;if(O(u,c)){let s=k(e,l),d=A(u,c);Ct(t,n,r,s,d,i,a,o)}else{let c=j(e);Dt(c,s,r,a,o)&&Mt(c,t,n,r,i,a,o);let u=M(e,l);Dt(u,s,r,a,o)&&Mt(u,t,n,r,i,a,o)}}var Nt=[`x`,`y`,`z`];function Pt(e,t,n,r,i,a){R.setBuffer(e._roots[t]);let o=Ft(0,e,n,r,i,a);return R.clearBuffer(),o}function Ft(e,t,n,r,i,a){let{float32Array:o,uint16Array:s,uint32Array:c}=R,l=e*2;if(O(l,s)){let o=k(e,c),u=A(l,s);return wt(t,n,r,o,u,i,a)}else{let s=Ie(e,c),l=Nt[s],u=r.direction[l]>=0,d,f;u?(d=j(e),f=M(e,c)):(d=M(e,c),f=j(e));let p=Dt(d,o,r,i,a)?Ft(d,t,n,r,i,a):null;if(p){let e=p.point[l];if(u?e<=o[f+s]:e>=o[f+s+3])return p}let m=Dt(f,o,r,i,a)?Ft(f,t,n,r,i,a):null;return p&&m?p.distance<=m.distance?p:m:p||m||null}}var It=new w,Lt=new F,Rt=new F,zt=new p,Bt=new I,Vt=new I;function Ht(e,t,n,r){R.setBuffer(e._roots[t]);let i=Ut(0,e,n,r);return R.clearBuffer(),i}function Ut(e,t,n,r,i=null){let{float32Array:a,uint16Array:o,uint32Array:s}=R,c=e*2;if(i===null&&(n.boundingBox||n.computeBoundingBox(),Bt.set(n.boundingBox.min,n.boundingBox.max,r),i=Bt),O(c,o)){let i=t.geometry,l=i.index,u=i.attributes.position,d=n.index,f=n.attributes.position,p=k(e,s),m=A(c,o);if(zt.copy(r).invert(),n.boundsTree)return E(N(e),a,Vt),Vt.matrix.copy(zt),Vt.needsUpdate=!0,n.boundsTree.shapecast({intersectsBounds:e=>Vt.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(r),e.b.applyMatrix4(r),e.c.applyMatrix4(r),e.needsUpdate=!0;for(let t=p*3,n=(m+p)*3;t<n;t+=3)if(z(Rt,t,l,u),Rt.needsUpdate=!0,e.intersectsTriangle(Rt))return!0;return!1}});for(let e=p*3,t=(m+p)*3;e<t;e+=3){z(Lt,e,l,u),Lt.a.applyMatrix4(zt),Lt.b.applyMatrix4(zt),Lt.c.applyMatrix4(zt),Lt.needsUpdate=!0;for(let e=0,t=d.count;e<t;e+=3)if(z(Rt,e,d,f),Rt.needsUpdate=!0,Lt.intersectsTriangle(Rt))return!0}}else{let o=e+8,c=s[e+6];return E(N(o),a,It),!!(i.intersectsBox(It)&&Ut(o,t,n,r,i)||(E(N(c),a,It),i.intersectsBox(It)&&Ut(c,t,n,r,i)))}}var Wt=new p,Gt=new I,Kt=new I,qt=new n,Jt=new n,Yt=new n,Xt=new n;function Zt(e,t,n,r={},i={},a=0,o=1/0){t.boundingBox||t.computeBoundingBox(),Gt.set(t.boundingBox.min,t.boundingBox.max,n),Gt.needsUpdate=!0;let s=e.geometry,c=s.attributes.position,l=s.index,u=t.attributes.position,d=t.index,f=L.getPrimitive(),p=L.getPrimitive(),m=qt,h=Jt,g=null,_=null;i&&(g=Yt,_=Xt);let v=1/0,y=null,b=null;return Wt.copy(n).invert(),Kt.matrix.copy(Wt),e.shapecast({boundsTraverseOrder:e=>Gt.distanceToBox(e),intersectsBounds:(e,t,n)=>n<v&&n<o?(t&&(Kt.min.copy(e.min),Kt.max.copy(e.max),Kt.needsUpdate=!0),!0):!1,intersectsRange:(e,r)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:e=>Kt.distanceToBox(e),intersectsBounds:(e,t,n)=>n<v&&n<o,intersectsRange:(t,i)=>{for(let o=t,s=t+i;o<s;o++){z(p,3*o,d,u),p.a.applyMatrix4(n),p.b.applyMatrix4(n),p.c.applyMatrix4(n),p.needsUpdate=!0;for(let t=e,n=e+r;t<n;t++){z(f,3*t,l,c),f.needsUpdate=!0;let e=f.distanceToTriangle(p,m,g);if(e<v&&(h.copy(m),_&&_.copy(g),v=e,y=t,b=o),e<a)return!0}}}});{let i=he(t);for(let t=0,o=i;t<o;t++){z(p,3*t,d,u),p.a.applyMatrix4(n),p.b.applyMatrix4(n),p.c.applyMatrix4(n),p.needsUpdate=!0;for(let n=e,i=e+r;n<i;n++){z(f,3*n,l,c),f.needsUpdate=!0;let e=f.distanceToTriangle(p,m,g);if(e<v&&(h.copy(m),_&&_.copy(g),v=e,y=n,b=t),e<a)return!0}}}}}),L.releasePrimitive(f),L.releasePrimitive(p),v===1/0?null:(r.point?r.point.copy(h):r.point=h.clone(),r.distance=v,r.faceIndex=y,i&&(i.point?i.point.copy(_):i.point=_.clone(),i.point.applyMatrix4(Wt),h.applyMatrix4(Wt),i.distance=h.sub(i.point).length(),i.faceIndex=b),r)}function Qt(e,t=null){t&&Array.isArray(t)&&(t=new Set(t));let n=e.geometry,r=n.index?n.index.array:null,i=n.attributes.position,a,o,s,c,l=0,u=e._roots;for(let e=0,t=u.length;e<t;e++)a=u[e],o=new Uint32Array(a),s=new Uint16Array(a),c=new Float32Array(a),d(0,l),l+=a.byteLength;function d(n,a,l=!1){let u=n*2;if(s[u+15]===65535){let t=o[n+6],a=s[u+14],l=1/0,d=1/0,f=1/0,p=-1/0,m=-1/0,h=-1/0;for(let n=t,o=t+a;n<o;n++){let t=3*e.resolveTriangleIndex(n);for(let e=0;e<3;e++){let n=t+e;n=r?r[n]:n;let a=i.getX(n),o=i.getY(n),s=i.getZ(n);a<l&&(l=a),a>p&&(p=a),o<d&&(d=o),o>m&&(m=o),s<f&&(f=s),s>h&&(h=s)}}return c[n+0]!==l||c[n+1]!==d||c[n+2]!==f||c[n+3]!==p||c[n+4]!==m||c[n+5]!==h?(c[n+0]=l,c[n+1]=d,c[n+2]=f,c[n+3]=p,c[n+4]=m,c[n+5]=h,!0):!1}else{let e=n+8,r=o[n+6],i=e+a,s=r+a,u=l,f=!1,p=!1;t?u||=(f=t.has(i),p=t.has(s),!f&&!p):(f=!0,p=!0);let m=u||f,h=u||p,g=!1;m&&(g=d(e,a,u));let _=!1;h&&(_=d(r,a,u));let v=g||_;if(v)for(let t=0;t<3;t++){let i=e+t,a=r+t,o=c[i],s=c[i+3],l=c[a],u=c[a+3];c[n+t]=o<l?o:l,c[n+t+3]=s>u?s:u}return v}}}function $t(e,t,n,r,i,a,o){R.setBuffer(e._roots[t]),en(0,e,n,r,i,a,o),R.clearBuffer()}function en(e,t,n,r,i,a,o){let{float32Array:s,uint16Array:c,uint32Array:l}=R,u=e*2;if(O(u,c)){let s=k(e,l),d=A(u,c);Ot(t,n,r,s,d,i,a,o)}else{let c=j(e);Dt(c,s,r,a,o)&&en(c,t,n,r,i,a,o);let u=M(e,l);Dt(u,s,r,a,o)&&en(u,t,n,r,i,a,o)}}var tn=[`x`,`y`,`z`];function nn(e,t,n,r,i,a){R.setBuffer(e._roots[t]);let o=rn(0,e,n,r,i,a);return R.clearBuffer(),o}function rn(e,t,n,r,i,a){let{float32Array:o,uint16Array:s,uint32Array:c}=R,l=e*2;if(O(l,s)){let o=k(e,c),u=A(l,s);return kt(t,n,r,o,u,i,a)}else{let s=Ie(e,c),l=tn[s],u=r.direction[l]>=0,d,f;u?(d=j(e),f=M(e,c)):(d=M(e,c),f=j(e));let p=Dt(d,o,r,i,a)?rn(d,t,n,r,i,a):null;if(p){let e=p.point[l];if(u?e<=o[f+s]:e>=o[f+s+3])return p}let m=Dt(f,o,r,i,a)?rn(f,t,n,r,i,a):null;return p&&m?p.distance<=m.distance?p:m:p||m||null}}var an=new w,on=new F,sn=new F,cn=new p,ln=new I,un=new I;function dn(e,t,n,r){R.setBuffer(e._roots[t]);let i=fn(0,e,n,r);return R.clearBuffer(),i}function fn(e,t,n,r,i=null){let{float32Array:a,uint16Array:o,uint32Array:s}=R,c=e*2;if(i===null&&(n.boundingBox||n.computeBoundingBox(),ln.set(n.boundingBox.min,n.boundingBox.max,r),i=ln),O(c,o)){let i=t.geometry,l=i.index,u=i.attributes.position,d=n.index,f=n.attributes.position,p=k(e,s),m=A(c,o);if(cn.copy(r).invert(),n.boundsTree)return E(N(e),a,un),un.matrix.copy(cn),un.needsUpdate=!0,n.boundsTree.shapecast({intersectsBounds:e=>un.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(r),e.b.applyMatrix4(r),e.c.applyMatrix4(r),e.needsUpdate=!0;for(let n=p,r=m+p;n<r;n++)if(z(sn,3*t.resolveTriangleIndex(n),l,u),sn.needsUpdate=!0,e.intersectsTriangle(sn))return!0;return!1}});for(let e=p,n=m+p;e<n;e++){let n=t.resolveTriangleIndex(e);z(on,3*n,l,u),on.a.applyMatrix4(cn),on.b.applyMatrix4(cn),on.c.applyMatrix4(cn),on.needsUpdate=!0;for(let e=0,t=d.count;e<t;e+=3)if(z(sn,e,d,f),sn.needsUpdate=!0,on.intersectsTriangle(sn))return!0}}else{let o=e+8,c=s[e+6];return E(N(o),a,an),!!(i.intersectsBox(an)&&fn(o,t,n,r,i)||(E(N(c),a,an),i.intersectsBox(an)&&fn(c,t,n,r,i)))}}var pn=new p,mn=new I,hn=new I,gn=new n,_n=new n,vn=new n,yn=new n;function bn(e,t,n,r={},i={},a=0,o=1/0){t.boundingBox||t.computeBoundingBox(),mn.set(t.boundingBox.min,t.boundingBox.max,n),mn.needsUpdate=!0;let s=e.geometry,c=s.attributes.position,l=s.index,u=t.attributes.position,d=t.index,f=L.getPrimitive(),p=L.getPrimitive(),m=gn,h=_n,g=null,_=null;i&&(g=vn,_=yn);let v=1/0,y=null,b=null;return pn.copy(n).invert(),hn.matrix.copy(pn),e.shapecast({boundsTraverseOrder:e=>mn.distanceToBox(e),intersectsBounds:(e,t,n)=>n<v&&n<o?(t&&(hn.min.copy(e.min),hn.max.copy(e.max),hn.needsUpdate=!0),!0):!1,intersectsRange:(r,i)=>{if(t.boundsTree){let s=t.boundsTree;return s.shapecast({boundsTraverseOrder:e=>hn.distanceToBox(e),intersectsBounds:(e,t,n)=>n<v&&n<o,intersectsRange:(t,o)=>{for(let x=t,S=t+o;x<S;x++){let t=s.resolveTriangleIndex(x);z(p,3*t,d,u),p.a.applyMatrix4(n),p.b.applyMatrix4(n),p.c.applyMatrix4(n),p.needsUpdate=!0;for(let t=r,n=r+i;t<n;t++){let n=e.resolveTriangleIndex(t);z(f,3*n,l,c),f.needsUpdate=!0;let r=f.distanceToTriangle(p,m,g);if(r<v&&(h.copy(m),_&&_.copy(g),v=r,y=t,b=x),r<a)return!0}}}})}else{let o=he(t);for(let t=0,s=o;t<s;t++){z(p,3*t,d,u),p.a.applyMatrix4(n),p.b.applyMatrix4(n),p.c.applyMatrix4(n),p.needsUpdate=!0;for(let n=r,o=r+i;n<o;n++){let r=e.resolveTriangleIndex(n);z(f,3*r,l,c),f.needsUpdate=!0;let i=f.distanceToTriangle(p,m,g);if(i<v&&(h.copy(m),_&&_.copy(g),v=i,y=n,b=t),i<a)return!0}}}}}),L.releasePrimitive(f),L.releasePrimitive(p),v===1/0?null:(r.point?r.point.copy(h):r.point=h.clone(),r.distance=v,r.faceIndex=y,i&&(i.point?i.point.copy(_):i.point=_.clone(),i.point.applyMatrix4(pn),h.applyMatrix4(pn),i.distance=h.sub(i.point).length(),i.faceIndex=b),r)}function xn(){return typeof SharedArrayBuffer<`u`}var Sn=new R.constructor,Cn=new R.constructor,wn=new $e(()=>new w),Tn=new w,En=new w,Dn=new w,On=new w,kn=!1;function An(e,t,n,r){if(kn)throw Error(`MeshBVH: Recursive calls to bvhcast not supported.`);kn=!0;let i=e._roots,a=t._roots,o,s=0,c=0,l=new p().copy(n).invert();for(let e=0,t=i.length;e<t;e++){Sn.setBuffer(i[e]),c=0;let t=wn.getPrimitive();E(N(0),Sn.float32Array,t),t.applyMatrix4(l);for(let e=0,i=a.length;e<i&&(Cn.setBuffer(a[e]),o=B(0,0,n,l,r,s,c,0,0,t),Cn.clearBuffer(),c+=a[e].length,!o);e++);if(wn.releasePrimitive(t),Sn.clearBuffer(),s+=i[e].length,o)break}return kn=!1,o}function B(e,t,n,r,i,a=0,o=0,s=0,c=0,l=null,u=!1){let d,f;u?(d=Cn,f=Sn):(d=Sn,f=Cn);let p=d.float32Array,m=d.uint32Array,h=d.uint16Array,g=f.float32Array,_=f.uint32Array,v=f.uint16Array,y=e*2,b=t*2,x=O(y,h),S=O(b,v),C=!1;if(S&&x)C=u?i(k(t,_),A(t*2,v),k(e,m),A(e*2,h),c,o+t,s,a+e):i(k(e,m),A(e*2,h),k(t,_),A(t*2,v),s,a+e,c,o+t);else if(S){let l=wn.getPrimitive();E(N(t),g,l),l.applyMatrix4(n);let d=j(e),f=M(e,m);E(N(d),p,Tn),E(N(f),p,En);let h=l.intersectsBox(Tn),_=l.intersectsBox(En);C=h&&B(t,d,r,n,i,o,a,c,s+1,l,!u)||_&&B(t,f,r,n,i,o,a,c,s+1,l,!u),wn.releasePrimitive(l)}else{let d=j(t),f=M(t,_);E(N(d),g,Dn),E(N(f),g,On);let h=l.intersectsBox(Dn),v=l.intersectsBox(On);if(h&&v)C=B(e,d,n,r,i,a,o,s,c+1,l,u)||B(e,f,n,r,i,a,o,s,c+1,l,u);else if(h)if(x)C=B(e,d,n,r,i,a,o,s,c+1,l,u);else{let t=wn.getPrimitive();t.copy(Dn).applyMatrix4(n);let l=j(e),f=M(e,m);E(N(l),p,Tn),E(N(f),p,En);let h=t.intersectsBox(Tn),g=t.intersectsBox(En);C=h&&B(d,l,r,n,i,o,a,c,s+1,t,!u)||g&&B(d,f,r,n,i,o,a,c,s+1,t,!u),wn.releasePrimitive(t)}else if(v)if(x)C=B(e,f,n,r,i,a,o,s,c+1,l,u);else{let t=wn.getPrimitive();t.copy(On).applyMatrix4(n);let l=j(e),d=M(e,m);E(N(l),p,Tn),E(N(d),p,En);let h=t.intersectsBox(Tn),g=t.intersectsBox(En);C=h&&B(f,l,r,n,i,o,a,c,s+1,t,!u)||g&&B(f,d,r,n,i,o,a,c,s+1,t,!u),wn.releasePrimitive(t)}}return C}var jn=new I,Mn=new w;const Nn={strategy:0,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};var Pn=class e{static serialize(e,t={}){t={cloneBuffers:!0,...t};let n=e.geometry,r=e._roots,i=e._indirectBuffer,a=n.getIndex(),o;return o=t.cloneBuffers?{roots:r.map(e=>e.slice()),index:a?a.array.slice():null,indirectBuffer:i?i.slice():null}:{roots:r,index:a?a.array:null,indirectBuffer:i},o}static deserialize(t,n,r={}){r={setIndex:!0,indirect:!!t.indirectBuffer,...r};let{index:i,roots:a,indirectBuffer:o}=t,s=new e(n,{...r,[pe]:!0});if(s._roots=a,s._indirectBuffer=o||null,r.setIndex){let e=n.getIndex();if(e===null){let e=new _(t.index,1,!1);n.setIndex(e)}else e.array!==i&&(e.array.set(i),e.needsUpdate=!0)}return s}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw Error(`MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.`)}else throw Error(`MeshBVH: Only BufferGeometries are supported.`);if(t=Object.assign({...Nn,[pe]:!1},t),t.useSharedArrayBuffer&&!xn())throw Error(`MeshBVH: SharedArrayBuffer is not available.`);this.geometry=e,this._roots=null,this._indirectBuffer=null,t[pe]||(qe(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new w))),this.resolveTriangleIndex=t.indirect?e=>this._indirectBuffer[e]:e=>e}refit(e=null){return(this.indirect?Qt:Et)(this,e)}traverse(e,t=0){let n=this._roots[t],r=new Uint32Array(n),i=new Uint16Array(n);a(0);function a(t,o=0){let s=t*2,c=i[s+15]===de;if(c){let a=r[t+6],l=i[s+14];e(o,c,new Float32Array(n,t*4,6),a,l)}else{let i=t+32/4,s=r[t+6],l=r[t+7];e(o,c,new Float32Array(n,t*4,6),l)||(a(i,o+1),a(s,o+1))}}}raycast(e,t=0,n=0,r=1/0){let i=this._roots,a=this.geometry,o=[],s=t.isMaterial,c=Array.isArray(t),l=a.groups,u=s?t.side:t,d=this.indirect?$t:jt;for(let a=0,s=i.length;a<s;a++){let i=c?t[l[a].materialIndex].side:u,s=o.length;if(d(this,a,i,e,o,n,r),c){let e=l[a].materialIndex;for(let t=s,n=o.length;t<n;t++)o[t].face.materialIndex=e}}return o}raycastFirst(e,t=0,n=0,r=1/0){let i=this._roots,a=this.geometry,o=t.isMaterial,s=Array.isArray(t),c=null,l=a.groups,u=o?t.side:t,d=this.indirect?nn:Pt;for(let a=0,o=i.length;a<o;a++){let i=s?t[l[a].materialIndex].side:u,o=d(this,a,i,e,n,r);o!=null&&(c==null||o.distance<c.distance)&&(c=o,s&&(o.face.materialIndex=l[a].materialIndex))}return c}intersectsGeometry(e,t){let n=!1,r=this._roots,i=this.indirect?dn:Ht;for(let a=0,o=r.length;a<o&&(n=i(this,a,e,t),!n);a++);return n}shapecast(e){let t=L.getPrimitive(),n=this.indirect?At:Tt,{boundsTraverseOrder:r,intersectsBounds:i,intersectsRange:a,intersectsTriangle:o}=e;if(a&&o){let e=a;a=(r,i,a,s,c)=>e(r,i,a,s,c)?!0:n(r,i,this,o,a,s,t)}else a||=o?(e,r,i,a)=>n(e,r,this,o,i,a,t):(e,t,n)=>n;let s=!1,c=0,l=this._roots;for(let e=0,t=l.length;e<t;e++){let t=l[e];if(s=it(this,e,i,a,r,c),s)break;c+=t.byteLength}return L.releasePrimitive(t),s}bvhcast(e,t,n){let{intersectsRanges:r,intersectsTriangles:i}=n,a=L.getPrimitive(),o=this.geometry.index,s=this.geometry.attributes.position,c=this.indirect?e=>{let t=this.resolveTriangleIndex(e);z(a,t*3,o,s)}:e=>{z(a,e*3,o,s)},l=L.getPrimitive(),u=e.geometry.index,d=e.geometry.attributes.position,f=e.indirect?t=>{let n=e.resolveTriangleIndex(t);z(l,n*3,u,d)}:e=>{z(l,e*3,u,d)};if(i){let e=(e,n,r,o,s,u,d,p)=>{for(let m=r,h=r+o;m<h;m++){f(m),l.a.applyMatrix4(t),l.b.applyMatrix4(t),l.c.applyMatrix4(t),l.needsUpdate=!0;for(let t=e,r=e+n;t<r;t++)if(c(t),a.needsUpdate=!0,i(a,l,t,m,s,u,d,p))return!0}return!1};if(r){let t=r;r=function(n,r,i,a,o,s,c,l){return t(n,r,i,a,o,s,c,l)?!0:e(n,r,i,a,o,s,c,l)}}else r=e}return An(this,e,t,r)}intersectsBox(e,t){return jn.set(e.min,e.max,t),jn.needsUpdate=!0,this.shapecast({intersectsBounds:e=>jn.intersectsBox(e),intersectsTriangle:e=>jn.intersectsTriangle(e)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,n={},r={},i=0,a=1/0){return(this.indirect?bn:Zt)(this,e,t,n,r,i,a)}closestPointToPoint(e,t={},n=0,r=1/0){return ct(this,e,t,n,r)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(t=>{E(0,new Float32Array(t),Mn),e.union(Mn)}),e}},Fn=1e-6,In=Fn*.5,Ln=10**-Math.log10(Fn),Rn=In*Ln;function V(e){return~~(e*Ln+Rn)}function zn(e){return`${V(e.x)},${V(e.y)}`}function Bn(e){return`${V(e.x)},${V(e.y)},${V(e.z)}`}function Vn(e){return`${V(e.x)},${V(e.y)},${V(e.z)},${V(e.w)}`}function Hn(e,t,n){n.direction.subVectors(t,e).normalize();let r=e.dot(n.direction);return n.origin.copy(e).addScaledVector(n.direction,-r),n}function Un(){return typeof SharedArrayBuffer<`u`}function Wn(e){if(e.buffer instanceof SharedArrayBuffer)return e;let t=e.constructor,n=e.buffer,r=new SharedArrayBuffer(n.byteLength),i=new Uint8Array(n);return new Uint8Array(r).set(i,0),new t(r)}function Gn(e,t=ArrayBuffer){return e>65535?new Uint32Array(new t(4*e)):new Uint16Array(new t(2*e))}function Kn(e,t){if(!e.index){let n=e.attributes.position.count,r=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=Gn(n,r);e.setIndex(new _(i,1));for(let e=0;e<n;e++)i[e]=e}}function qn(e){return e.index?e.index.count:e.attributes.position.count}function Jn(e){return qn(e)/3}var Yn=1e-8,Xn=new n;function Zn(e){return~~(e/3)}function Qn(e){return e%3}function $n(e,t){return e.start-t.start}function er(e,t){return Xn.subVectors(t,e.origin).dot(e.direction)}function tr(e,t,n,r=Yn){e.sort($n),t.sort($n);for(let r=0;r<e.length;r++){let i=e[r];for(let s=0;s<t.length;s++){let c=t[s];if(!(c.start>i.end)){if(i.end<c.start||c.end<i.start)continue;if(i.start<=c.start&&i.end>=c.end)a(c.end,i.end)||e.splice(r+1,0,{start:c.end,end:i.end,index:i.index}),i.end=c.start,c.start=0,c.end=0;else if(i.start>=c.start&&i.end<=c.end)a(i.end,c.end)||t.splice(s+1,0,{start:i.end,end:c.end,index:c.index}),c.end=i.start,i.start=0,i.end=0;else if(i.start<=c.start&&i.end<=c.end){let e=i.end;i.end=c.start,c.start=e}else if(i.start>=c.start&&i.end>=c.end){let e=c.end;c.end=i.start,i.start=e}else throw Error()}if(n.has(i.index)||n.set(i.index,[]),n.has(c.index)||n.set(c.index,[]),n.get(i.index).push(c.index),n.get(c.index).push(i.index),o(c)&&(t.splice(s,1),s--),o(i)){e.splice(r,1),r--;break}}}i(e),i(t);function i(e){for(let t=0;t<e.length;t++)o(e[t])&&(e.splice(t,1),t--)}function a(e,t){return Math.abs(t-e)<r}function o(e){return Math.abs(e.end-e.start)<r}}var nr=1e-5,rr=1e-4,ir=class{constructor(){this._rays=[]}addRay(e){this._rays.push(e)}findClosestRay(e){let t=this._rays,n=e.clone();n.direction.multiplyScalar(-1);let r=1/0,i=null;for(let s=0,c=t.length;s<c;s++){let c=t[s];if(a(c,e)&&a(c,n))continue;let l=o(c,e),u=o(c,n),d=Math.min(l,u);d<r&&(r=d,i=c)}return i;function a(e,t){let n=e.origin.distanceTo(t.origin)>nr;return e.direction.angleTo(t.direction)>rr||n}function o(e,t){let n=e.origin.distanceTo(t.origin),r=e.direction.angleTo(t.direction);return n/nr+r/rr}}},ar=new n,or=new n,sr=new f;function cr(e,t,n){let r=e.attributes,i=e.index,a=r.position,o=new Map,s=new Map,c=Array.from(t),l=new ir;for(let e=0,t=c.length;e<t;e++){let t=c[e],n=Zn(t),r=Qn(t),o=3*n+r,u=3*n+(r+1)%3;i&&(o=i.getX(o),u=i.getX(u)),ar.fromBufferAttribute(a,o),or.fromBufferAttribute(a,u),Hn(ar,or,sr);let d,f=l.findClosestRay(sr);f===null&&(f=sr.clone(),l.addRay(f)),s.has(f)||s.set(f,{forward:[],reverse:[],ray:f}),d=s.get(f);let p=er(f,ar),m=er(f,or);p>m&&([p,m]=[m,p]),sr.direction.dot(f.direction)<0?d.reverse.push({start:p,end:m,index:t}):d.forward.push({start:p,end:m,index:t})}return s.forEach(({forward:e,reverse:t},r)=>{tr(e,t,o,n),e.length===0&&t.length===0&&s.delete(r)}),{disjointConnectivityMap:o,fragmentMap:s}}var lr=new r,ur=new n,dr=new l,fr=[``,``,``],pr=class{constructor(e=null){this.data=null,this.disjointConnections=null,this.unmatchedDisjointEdges=null,this.unmatchedEdges=-1,this.matchedEdges=-1,this.useDrawRange=!0,this.useAllAttributes=!1,this.matchDisjointEdges=!1,this.degenerateEpsilon=1e-8,e&&this.updateFrom(e)}getSiblingTriangleIndex(e,t){let n=this.data[e*3+t];return n===-1?-1:~~(n/3)}getSiblingEdgeIndex(e,t){let n=this.data[e*3+t];return n===-1?-1:n%3}getDisjointSiblingTriangleIndices(e,t){let n=e*3+t,r=this.disjointConnections.get(n);return r?r.map(e=>~~(e/3)):[]}getDisjointSiblingEdgeIndices(e,t){let n=e*3+t,r=this.disjointConnections.get(n);return r?r.map(e=>e%3):[]}isFullyConnected(){return this.unmatchedEdges===0}updateFrom(e){let{useAllAttributes:t,useDrawRange:n,matchDisjointEdges:r,degenerateEpsilon:i}=this,a=t?v:_,o=new Map,{attributes:s}=e,c=t?Object.keys(s):null,l=e.index,u=s.position,d=Jn(e),f=d,p=0;n&&(p=e.drawRange.start,e.drawRange.count!==1/0&&(d=~~(e.drawRange.count/3)));let m=this.data;(!m||m.length<3*f)&&(m=new Int32Array(3*f)),m.fill(-1);let h=0,g=new Set;for(let e=p,t=d*3+p;e<t;e+=3){let t=e;for(let e=0;e<3;e++){let n=t+e;l&&(n=l.getX(n)),fr[e]=a(n)}for(let e=0;e<3;e++){let n=(e+1)%3,r=fr[e],i=fr[n],a=`${i}_${r}`;if(o.has(a)){let n=t+e,r=o.get(a);m[n]=r,m[r]=n,o.delete(a),h+=2,g.delete(r)}else{let n=`${r}_${i}`,a=t+e;o.set(n,a),g.add(a)}}}if(r){let{fragmentMap:t,disjointConnectivityMap:n}=cr(e,g,i);g.clear(),t.forEach(({forward:e,reverse:t})=>{e.forEach(({index:e})=>g.add(e)),t.forEach(({index:e})=>g.add(e))}),this.unmatchedDisjointEdges=t,this.disjointConnections=n,h=d*3-g.size}this.matchedEdges=h,this.unmatchedEdges=g.size,this.data=m;function _(e){return ur.fromBufferAttribute(u,e),Bn(ur)}function v(e){let t=``;for(let n=0,r=c.length;n<r;n++){let r=s[c[n]],i;switch(r.itemSize){case 1:i=V(r.getX(e));break;case 2:i=zn(lr.fromBufferAttribute(r,e));break;case 3:i=Bn(ur.fromBufferAttribute(r,e));break;case 4:i=Vn(dr.fromBufferAttribute(r,e));break}t!==``&&(t+=`|`),t+=i}return t}}},mr=class extends ie{constructor(...e){super(...e),this.isBrush=!0,this._previousMatrix=new p,this._previousMatrix.elements.fill(0)}markUpdated(){this._previousMatrix.copy(this.matrix)}isDirty(){let{matrix:e,_previousMatrix:t}=this,n=e.elements,r=t.elements;for(let e=0;e<16;e++)if(n[e]!==r[e])return!0;return!1}prepareGeometry(){let e=this.geometry,t=e.attributes,n=Un();if(n)for(let e in t){let n=t[e];if(n.isInterleavedBufferAttribute)throw Error(`Brush: InterleavedBufferAttributes are not supported.`);n.array=Wn(n.array)}if(e.boundsTree||=(Kn(e,{useSharedArrayBuffer:n}),new Pn(e,{maxLeafTris:3,indirect:!0,useSharedArrayBuffer:n})),e.halfEdges||=new pr(e),!e.groupIndices){let t=Jn(e),n=new Uint16Array(t),r=e.groups;for(let e=0,t=r.length;e<t;e++){let{start:t,count:i}=r[e];for(let r=t/3,a=(t+i)/3;r<a;r++)n[r]=e}e.groupIndices=n}}disposeCacheData(){let{geometry:e}=this;e.halfEdges=null,e.boundsTree=null,e.groupIndices=null}},hr=1e-14,gr=new n,_r=new n,vr=new n;function yr(e,t=hr){gr.subVectors(e.b,e.a),_r.subVectors(e.c,e.a),vr.subVectors(e.b,e.c);let n=gr.angleTo(_r),r=gr.angleTo(vr),i=Math.PI-n-r;return Math.abs(n)<t||Math.abs(r)<t||Math.abs(i)<t||e.a.distanceToSquared(e.b)<t||e.a.distanceToSquared(e.c)<t||e.b.distanceToSquared(e.c)<t}var br=1e-10,xr=1e-10,Sr=1e-10,H=new S,U=new S,W=new n,Cr=new n,wr=new n,Tr=new s,Er=new F,Dr=class{constructor(){this._pool=[],this._index=0}getTriangle(){return this._index>=this._pool.length&&this._pool.push(new T),this._pool[this._index++]}clear(){this._index=0}reset(){this._pool.length=0,this._index=0}},Or=class{constructor(){this.trianglePool=new Dr,this.triangles=[],this.normal=new n,this.coplanarTriangleUsed=!1}initialize(e){this.reset();let{triangles:t,trianglePool:n,normal:r}=this;if(Array.isArray(e))for(let i=0,a=e.length;i<a;i++){let a=e[i];if(i===0)a.getNormal(r);else if(Math.abs(1-a.getNormal(W).dot(r))>br)throw Error(`Triangle Splitter: Cannot initialize with triangles that have different normals.`);let o=n.getTriangle();o.copy(a),t.push(o)}else{e.getNormal(r);let i=n.getTriangle();i.copy(e),t.push(i)}}splitByTriangle(e){let{normal:t,triangles:n}=this;if(e.getNormal(Cr).normalize(),Math.abs(1-Math.abs(Cr.dot(t)))<Sr){this.coplanarTriangleUsed=!0;for(let e=0,t=n.length;e<t;e++){let t=n[e];t.coplanarCount=0}let t=[e.a,e.b,e.c];for(let n=0;n<3;n++){let r=(n+1)%3,i=t[n],a=t[r];W.subVectors(a,i).normalize(),wr.crossVectors(Cr,W),Tr.setFromNormalAndCoplanarPoint(wr,i),this.splitByPlane(Tr,e)}}else e.getPlane(Tr),this.splitByPlane(Tr,e)}splitByPlane(e,t){let{triangles:n,trianglePool:r}=this;Er.copy(t),Er.needsUpdate=!0;for(let t=0,i=n.length;t<i;t++){let a=n[t];if(!Er.intersectsTriangle(a,H,!0))continue;let{a:o,b:s,c}=a,l=0,u=-1,d=!1,f=[],p=[],m=[o,s,c];for(let t=0;t<3;t++){let n=(t+1)%3;H.start.copy(m[t]),H.end.copy(m[n]);let r=e.distanceToPoint(H.start),i=e.distanceToPoint(H.end);if(Math.abs(r)<xr&&Math.abs(i)<xr){d=!0;break}if(r>0?f.push(t):p.push(t),Math.abs(r)<xr)continue;let a=!!e.intersectLine(H,W);!a&&Math.abs(i)<xr&&(W.copy(H.end),a=!0),a&&!(W.distanceTo(H.start)<br)&&(W.distanceTo(H.end)<br&&(u=t),l===0?U.start.copy(W):U.end.copy(W),l++)}if(!d&&l===2&&U.distance()>xr)if(u!==-1){u=(u+1)%3;let e=0;e===u&&(e=(e+1)%3);let o=e+1;o===u&&(o=(o+1)%3);let s=r.getTriangle();s.a.copy(m[o]),s.b.copy(U.end),s.c.copy(U.start),yr(s)||n.push(s),a.a.copy(m[e]),a.b.copy(U.start),a.c.copy(U.end),yr(a)&&(n.splice(t,1),t--,i--)}else{let e=f.length>=2?p[0]:f[0];if(e===0){let e=U.start;U.start=U.end,U.end=e}let o=(e+1)%3,s=(e+2)%3,c=r.getTriangle(),l=r.getTriangle();m[o].distanceToSquared(U.start)<m[s].distanceToSquared(U.end)?(c.a.copy(m[o]),c.b.copy(U.start),c.c.copy(U.end),l.a.copy(m[o]),l.b.copy(m[s]),l.c.copy(U.start)):(c.a.copy(m[s]),c.b.copy(U.start),c.c.copy(U.end),l.a.copy(m[o]),l.b.copy(m[s]),l.c.copy(U.end)),a.a.copy(m[e]),a.b.copy(U.end),a.c.copy(U.start),yr(c)||n.push(c),yr(l)||n.push(l),yr(a)&&(n.splice(t,1),t--,i--)}else l===3&&console.warn(`TriangleClipper: Coplanar clip not handled`)}}reset(){this.triangles.length=0,this.trianglePool.clear(),this.coplanarTriangleUsed=!1}};function kr(e){return e=~~e,e+4-e%4}var Ar=class{constructor(e,t=500){this.expansionFactor=1.5,this.type=e,this.length=0,this.array=null,this.setSize(t)}setType(e){if(this.length!==0)throw Error(`TypeBackedArray: Cannot change the type while there is used data in the buffer.`);let t=this.array.buffer;this.array=new e(t),this.type=e}setSize(e){if(this.array&&e===this.array.length)return;let t=this.type,n=Un()?SharedArrayBuffer:ArrayBuffer,r=new t(new n(kr(e*t.BYTES_PER_ELEMENT)));this.array&&r.set(this.array,0),this.array=r}expand(){let{array:e,expansionFactor:t}=this;this.setSize(e.length*t)}push(...e){let{array:t,length:n}=this;n+e.length>t.length&&(this.expand(),t=this.array);for(let r=0,i=e.length;r<i;r++)t[n+r]=e[r];this.length+=e.length}clear(){this.length=0}},jr=class{constructor(){this.groupAttributes=[{}],this.groupCount=0}getType(e){return this.groupAttributes[0][e].type}getItemSize(e){return this.groupAttributes[0][e].itemSize}getNormalized(e){return this.groupAttributes[0][e].normalized}getCount(e){if(this.groupCount<=e)return 0;let t=this.getGroupAttrArray(`position`,e);return t.length/t.itemSize}getTotalLength(e){let{groupCount:t,groupAttributes:n}=this,r=0;for(let i=0;i<t;i++){let t=n[i];r+=t[e].length}return r}getGroupAttrSet(e=0){let{groupAttributes:t}=this;if(t[e])return this.groupCount=Math.max(this.groupCount,e+1),t[e];let n=t[0];for(this.groupCount=Math.max(this.groupCount,e+1);e>=t.length;){let e={};for(let r in t.push(e),n){let t=n[r],i=new Ar(t.type);i.itemSize=t.itemSize,i.normalized=t.normalized,e[r]=i}}return t[e]}getGroupAttrArray(e,t=0){let{groupAttributes:n}=this;if(!n[0][e])throw Error(`TypedAttributeData: Attribute with "${e}" has not been initialized`);return this.getGroupAttrSet(t)[e]}initializeArray(e,t,n,r){let{groupAttributes:i}=this,a=i[0][e];if(a){if(a.type!==t)for(let a=0,o=i.length;a<o;a++){let o=i[a][e];o.setType(t),o.itemSize=n,o.normalized=r}}else for(let a=0,o=i.length;a<o;a++){let o=new Ar(t);o.itemSize=n,o.normalized=r,i[a][e]=o}}clear(){this.groupCount=0;let{groupAttributes:e}=this;e.forEach(e=>{for(let t in e)e[t].clear()})}delete(e){this.groupAttributes.forEach(t=>{delete t[e]})}reset(){this.groupAttributes=[],this.groupCount=0}},Mr=class{constructor(){this.intersectionSet={},this.ids=[]}add(e,t){let{intersectionSet:n,ids:r}=this;n[e]||(n[e]=[],r.push(e)),n[e].push(t)}},G=new f,Nr=new p,K=new T,q=new n,Pr=new l,Fr=new l,Ir=new l,Lr=new l,Rr=new l,zr=new l,Br=new S,Vr=new n,Hr=1e-8,Ur=1e-15,Wr=1e-14,Gr=null;function Kr(e){Gr=e}function qr(e,t){e.getMidpoint(G.origin),e.getNormal(G.direction);let n=t.raycastFirst(G,2);return n&&G.direction.dot(n.face.normal)>0?-1:1}function Jr(e,t){function n(){return Math.random()-.5}e.getNormal(Vr),G.direction.copy(Vr),e.getMidpoint(G.origin);let r=0,i=1/0;for(let e=0;e<3;e++){G.direction.x+=n()*Hr,G.direction.y+=n()*Hr,G.direction.z+=n()*Hr,G.direction.multiplyScalar(-1);let a=t.raycastFirst(G,2);if(a&&G.direction.dot(a.face.normal)>0&&r++,a!==null&&(i=Math.min(i,a.distance)),i<=Ur)return a.face.normal.dot(Vr)>0?2:-2;if(r/3>.5||(e-r+1)/3>.5)break}return r/3>.5?-1:1}function Yr(e,t){let n=new Mr,r=new Mr;return Nr.copy(e.matrixWorld).invert().multiply(t.matrixWorld),e.geometry.boundsTree.bvhcast(t.geometry.boundsTree,Nr,{intersectsTriangles(i,a,o,s){if(!yr(i)&&!yr(a)){let c=i.intersectsTriangle(a,Br,!0);if(!c){let e=i.plane,t=a.plane,n=e.normal,r=t.normal;n.dot(r)===1&&Math.abs(e.constant-t.constant)<Wr&&(c=!0)}if(c){let c=e.geometry.boundsTree.resolveTriangleIndex(o),l=t.geometry.boundsTree.resolveTriangleIndex(s);n.add(c,l),r.add(l,c),Gr&&(Gr.addEdge(Br),Gr.addIntersectingTriangles(o,i,s,a))}}return!1}}),{aIntersections:n,bIntersections:r}}function Xr(e,t,n,r,i,a,o=!1){let s=n.attributes,c=n.index,l=e*3,u=c.getX(l+0),d=c.getX(l+1),f=c.getX(l+2);for(let e in a){let n=s[e],c=a[e];if(!(e in s))throw Error(`CSG Operations: Attribute ${e} not available on geometry.`);let l=n.itemSize;e===`position`?(K.a.fromBufferAttribute(n,u).applyMatrix4(r),K.b.fromBufferAttribute(n,d).applyMatrix4(r),K.c.fromBufferAttribute(n,f).applyMatrix4(r),$r(K.a,K.b,K.c,t,3,c,o)):e===`normal`?(K.a.fromBufferAttribute(n,u).applyNormalMatrix(i),K.b.fromBufferAttribute(n,d).applyNormalMatrix(i),K.c.fromBufferAttribute(n,f).applyNormalMatrix(i),o&&(K.a.multiplyScalar(-1),K.b.multiplyScalar(-1),K.c.multiplyScalar(-1)),$r(K.a,K.b,K.c,t,3,c,o,!0)):(Pr.fromBufferAttribute(n,u),Fr.fromBufferAttribute(n,d),Ir.fromBufferAttribute(n,f),$r(Pr,Fr,Ir,t,l,c,o))}}function Zr(e,t,n,r,i,a,o,s=!1){ei(e,r,i,a,o,s),ei(s?n:t,r,i,a,o,s),ei(s?t:n,r,i,a,o,s)}function Qr(e,t,n=!1){switch(e){case 0:if(t===1||t===2&&!n)return 1;break;case 1:if(n){if(t===-1)return 0}else if(t===1||t===-2)return 1;break;case 2:if(n){if(t===1||t===-2)return 1}else if(t===-1)return 0;break;case 4:if(t===-1)return 0;if(t===1)return 1;break;case 3:if(t===-1||t===2&&!n)return 1;break;case 5:if(!n&&(t===1||t===-2))return 1;break;case 6:if(!n&&(t===-1||t===2))return 1;break;default:throw Error(`Unrecognized CSG operation enum "${e}".`)}return 2}function $r(e,t,n,r,i,a,o=!1,s=!1){let c=e=>{a.push(e.x),i>1&&a.push(e.y),i>2&&a.push(e.z),i>3&&a.push(e.w)};Lr.set(0,0,0,0).addScaledVector(e,r.a.x).addScaledVector(t,r.a.y).addScaledVector(n,r.a.z),Rr.set(0,0,0,0).addScaledVector(e,r.b.x).addScaledVector(t,r.b.y).addScaledVector(n,r.b.z),zr.set(0,0,0,0).addScaledVector(e,r.c.x).addScaledVector(t,r.c.y).addScaledVector(n,r.c.z),s&&(Lr.normalize(),Rr.normalize(),zr.normalize()),c(Lr),o?(c(zr),c(Rr)):(c(Rr),c(zr))}function ei(e,t,n,r,i,a=!1){for(let o in i){let s=t[o],c=i[o];if(!(o in t))throw Error(`CSG Operations: Attribute ${o} no available on geometry.`);let l=s.itemSize;o===`position`?(q.fromBufferAttribute(s,e).applyMatrix4(n),c.push(q.x,q.y,q.z)):o===`normal`?(q.fromBufferAttribute(s,e).applyNormalMatrix(r),a&&q.multiplyScalar(-1),c.push(q.x,q.y,q.z)):(c.push(s.getX(e)),l>1&&c.push(s.getY(e)),l>2&&c.push(s.getZ(e)),l>3&&c.push(s.getW(e)))}}var ti=class{constructor(e){this.triangle=new T().copy(e),this.intersects={}}addTriangle(e,t){this.intersects[e]=new T().copy(t)}getIntersectArray(){let e=[],{intersects:t}=this;for(let n in t)e.push(t[n]);return e}},ni=class{constructor(){this.data={}}addTriangleIntersection(e,t,n,r){let{data:i}=this;i[e]||(i[e]=new ti(t)),i[e].addTriangle(n,r)}getTrianglesAsArray(e=null){let{data:t}=this,n=[];if(e!==null)e in t&&n.push(t[e].triangle);else for(let e in t)n.push(t[e].triangle);return n}getTriangleIndices(){return Object.keys(this.data).map(e=>parseInt(e))}getIntersectionIndices(e){let{data:t}=this;return t[e]?Object.keys(t[e].intersects).map(e=>parseInt(e)):[]}getIntersectionsAsArray(e=null,t=null){let{data:n}=this,r=new Set,i=[],a=e=>{if(n[e])if(t!==null)n[e].intersects[t]&&i.push(n[e].intersects[t]);else{let t=n[e].intersects;for(let e in t)r.has(e)||(r.add(e),i.push(t[e]))}};if(e!==null)a(e);else for(let e in n)a(e);return i}reset(){this.data={}}},ri=class{constructor(){this.enabled=!1,this.triangleIntersectsA=new ni,this.triangleIntersectsB=new ni,this.intersectionEdges=[]}addIntersectingTriangles(e,t,n,r){let{triangleIntersectsA:i,triangleIntersectsB:a}=this;i.addTriangleIntersection(e,t,n,r),a.addTriangleIntersection(n,r,e,t)}addEdge(e){this.intersectionEdges.push(e.clone())}reset(){this.triangleIntersectsA.reset(),this.triangleIntersectsB.reset(),this.intersectionEdges=[]}init(){this.enabled&&(this.reset(),Kr(this))}complete(){this.enabled&&Kr(null)}},ii=new p,ai=new g,oi=new T,si=new T,ci=new T,li=new T,J=[],ui=[];function di(e){for(let t of e)return t}function fi(e,t,n,r,i,a={}){let{useGroups:o=!0}=a,{aIntersections:s,bIntersections:c}=Yr(e,t),l=[],u;return u=o?0:-1,pi(e,t,s,n,!1,r,i,u),mi(e,t,s,n,!1,i,u),n.findIndex(e=>e!==6&&e!==5)!==-1&&(u=o?e.geometry.groups.length||1:-1,pi(t,e,c,n,!0,r,i,u),mi(t,e,c,n,!0,i,u)),J.length=0,ui.length=0,{groups:l,materials:null}}function pi(e,t,n,r,i,a,o,s=0){let c=e.matrixWorld.determinant()<0;ii.copy(t.matrixWorld).invert().multiply(e.matrixWorld),ai.getNormalMatrix(e.matrixWorld).multiplyScalar(c?-1:1);let l=e.geometry.groupIndices,u=e.geometry.index,d=e.geometry.attributes.position,f=t.geometry.boundsTree,p=t.geometry.index,m=t.geometry.attributes.position,h=n.ids,g=n.intersectionSet;for(let t=0,n=h.length;t<n;t++){let n=h[t],_=s===-1?0:l[n]+s,v=3*n,y=u.getX(v+0),b=u.getX(v+1),x=u.getX(v+2);oi.a.fromBufferAttribute(d,y).applyMatrix4(ii),oi.b.fromBufferAttribute(d,b).applyMatrix4(ii),oi.c.fromBufferAttribute(d,x).applyMatrix4(ii),a.reset(),a.initialize(oi);let S=g[n];for(let e=0,t=S.length;e<t;e++){let t=3*S[e],n=p.getX(t+0),r=p.getX(t+1),i=p.getX(t+2);si.a.fromBufferAttribute(m,n),si.b.fromBufferAttribute(m,r),si.c.fromBufferAttribute(m,i),a.splitByTriangle(si)}let C=a.triangles;for(let t=0,s=C.length;t<s;t++){let s=C[t],l=a.coplanarTriangleUsed?Jr(s,f):qr(s,f);J.length=0,ui.length=0;for(let e=0,t=r.length;e<t;e++){let t=Qr(r[e],l,i);t!==2&&(ui.push(t),J.push(o[e].getGroupAttrSet(_)))}if(J.length!==0){oi.getBarycoord(s.a,li.a),oi.getBarycoord(s.b,li.b),oi.getBarycoord(s.c,li.c);for(let t=0,r=J.length;t<r;t++){let r=J[t],i=ui[t]===0;Xr(n,li,e.geometry,e.matrixWorld,ai,r,c!==i)}}}}return h.length}function mi(e,t,n,r,i,a,o=0){let s=e.matrixWorld.determinant()<0;ii.copy(t.matrixWorld).invert().multiply(e.matrixWorld),ai.getNormalMatrix(e.matrixWorld).multiplyScalar(s?-1:1);let c=t.geometry.boundsTree,l=e.geometry.groupIndices,u=e.geometry.index,d=e.geometry.attributes,f=d.position,p=[],m=e.geometry.halfEdges,h=new Set,g=Jn(e.geometry);for(let e=0,t=g;e<t;e++)e in n.intersectionSet||h.add(e);for(;h.size>0;){let t=di(h);h.delete(t),p.push(t);let n=3*t,g=u.getX(n+0),_=u.getX(n+1),v=u.getX(n+2);ci.a.fromBufferAttribute(f,g).applyMatrix4(ii),ci.b.fromBufferAttribute(f,_).applyMatrix4(ii),ci.c.fromBufferAttribute(f,v).applyMatrix4(ii);let y=qr(ci,c);ui.length=0,J.length=0;for(let e=0,t=r.length;e<t;e++){let t=Qr(r[e],y,i);t!==2&&(ui.push(t),J.push(a[e]))}for(;p.length>0;){let t=p.pop();for(let e=0;e<3;e++){let n=m.getSiblingTriangleIndex(t,e);n!==-1&&h.has(n)&&(p.push(n),h.delete(n))}if(J.length!==0){let n=3*t,r=u.getX(n+0),i=u.getX(n+1),a=u.getX(n+2),c=o===-1?0:l[t]+o;if(ci.a.fromBufferAttribute(f,r),ci.b.fromBufferAttribute(f,i),ci.c.fromBufferAttribute(f,a),!yr(ci))for(let t=0,n=J.length;t<n;t++){let n=ui[t],o=J[t].getGroupAttrSet(c),l=n===0;Zr(r,i,a,d,e.matrixWorld,ai,o,l!==s)}}}}}function hi(e){for(let t=0;t<e.length-1;t++){let n=e[t],r=e[t+1];if(n.materialIndex===r.materialIndex){let i=n.start,a=r.start+r.count;r.start=i,r.count=a-i,e.splice(t,1),t--}}}function gi(e,t,n,r){n.clear();let i=e.attributes;for(let e=0,t=r.length;e<t;e++){let t=r[e],a=i[t];n.initializeArray(t,a.array.constructor,a.itemSize,a.normalized)}for(let e in n.attributes)r.includes(e)||n.delete(e);for(let e in t.attributes)r.includes(e)||(t.deleteAttribute(e),t.dispose())}function _i(e,t,n){let r=!1,i=-1,a=e.attributes,o=t.groupAttributes[0];for(let s in o){let o=t.getTotalLength(s),c=t.getType(s),l=t.getItemSize(s),u=t.getNormalized(s),d=a[s];(!d||d.array.length<o)&&(d=new _(new c(o),l,u),e.setAttribute(s,d),r=!0);let f=0;for(let e=0,r=Math.min(n.length,t.groupCount);e<r;e++){let r=n[e].index,{array:i,type:a,length:o}=t.groupAttributes[r][s],c=new a(i.buffer,0,o);d.array.set(c,f),f+=c.length}d.needsUpdate=!0,i=o/d.itemSize}if(e.index){let t=e.index.array;if(t.length<i)e.index=null,r=!0;else for(let e=0,n=t.length;e<n;e++)t[e]=e}let s=0;e.clearGroups();for(let r=0,i=Math.min(n.length,t.groupCount);r<i;r++){let{index:i,materialIndex:a}=n[r],o=t.getCount(i);o!==0&&(e.addGroup(s,o,a),s+=o)}e.setDrawRange(0,i),e.boundsTree=null,r&&e.dispose()}function vi(e,t){let n=t;return Array.isArray(t)||(n=[],e.forEach(e=>{n[e.materialIndex]=t})),n}var yi=class{constructor(){this.triangleSplitter=new Or,this.attributeData=[],this.attributes=[`position`,`uv`,`normal`],this.useGroups=!0,this.consolidateGroups=!0,this.debug=new ri}getGroupRanges(e){return!this.useGroups||e.groups.length===0?[{start:0,count:1/0,materialIndex:0}]:e.groups.map(e=>({...e}))}evaluate(e,t,n,r=new mr){let i=!0;if(Array.isArray(n)||(n=[n]),Array.isArray(r)||(r=[r],i=!1),r.length!==n.length)throw Error(`Evaluator: operations and target array passed as different sizes.`);e.prepareGeometry(),t.prepareGeometry();let{triangleSplitter:a,attributeData:o,attributes:s,useGroups:c,consolidateGroups:l,debug:u}=this;for(;o.length<r.length;)o.push(new jr);r.forEach((t,n)=>{gi(e.geometry,t.geometry,o[n],s)}),u.init(),fi(e,t,n,a,o,{useGroups:c}),u.complete();let d=this.getGroupRanges(e.geometry),f=vi(d,e.material),p=this.getGroupRanges(t.geometry),m=vi(p,t.material);p.forEach(e=>e.materialIndex+=f.length);let h=[...d,...p].map((e,t)=>({...e,index:t}));if(c){let e=[...f,...m];l&&(h=h.map(t=>{let n=e[t.materialIndex];return t.materialIndex=e.indexOf(n),t}).sort((e,t)=>e.materialIndex-t.materialIndex));let t=[];for(let n=0,r=e.length;n<r;n++){let r=!1;for(let e=0,i=h.length;e<i;e++){let i=h[e];i.materialIndex===n&&(r=!0,i.materialIndex=t.length)}r&&t.push(e[n])}r.forEach(e=>{e.material=t})}else h=[{start:0,count:1/0,index:0,materialIndex:0}],r.forEach(e=>{e.material=f[0]});return r.forEach((e,t)=>{let n=e.geometry;_i(n,o[t],h),l&&hi(n.groups)}),i?r:r[0]}evaluateHierarchy(e,t=new mr){e.updateMatrixWorld(!0);let n=(e,t)=>{let r=e.children;for(let e=0,i=r.length;e<i;e++){let i=r[e];i.isOperationGroup?n(i,t):t(i)}},r=e=>{let t=e.children,i=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];i=r(n)||i}let a=e.isDirty();if(a&&e.markUpdated(),i&&!e.isOperationGroup){let t;return n(e,n=>{t=t?this.evaluate(t,n,n.operation):this.evaluate(e,n,n.operation)}),e._cachedGeometry=t.geometry,e._cachedMaterials=t.material,!0}else return i||a};return r(e),t.geometry=e._cachedGeometry,t.material=e._cachedMaterials,t}reset(){this.triangleSplitter.reset()}},bi=`uniform float uTime;

uniform vec3 uColorWaterDeep;
uniform vec3 uColorWaterSurface;
uniform vec3 uColorSand;
uniform vec3 uColorGrass;
uniform vec3 uColorSnow;
uniform vec3 uColorRock;

varying vec2 vUv;
varying vec3 vPosition;
varying vec3 vNormalElevated;

const float waterLevel = -0.1;
const float sandTop = -0.05;
const float grassTop = 0.0;
const float snowCapStart = 0.7;

vec3 permute(vec3 x) { return mod(((x*44.0)+1.0)*x, 299.0); }

float simplexNoise2d(vec2 v)
{
    const vec4 C = vec4(0.211324865405187, 0.366025403784439,
            -0.577350269189626, 0.024390243902439);
    vec2 i  = floor(v + dot(v, C.yy) );
    vec2 x0 = v -   i + dot(i, C.xx);
    vec2 i1;
    i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
    vec4 x12 = x0.xyxy + C.xxzz;
    x12.xy -= i1;
    i = mod(i, 299.0);
    vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
    + i.x + vec3(0.0, i1.x, 1.0 ));
    vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy),
    dot(x12.zw,x12.zw)), 0.0);
    m = m*m ;
    m = m*m ;
    vec3 x = 2.0 * fract(p * C.www) - 1.0;
    vec3 h = abs(x) - 0.5;
    vec3 ox = floor(x + 0.5);
    vec3 a0 = x - ox;
    m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );
    vec3 g;
    g.x  = a0.x  * x0.x  + h.x  * x0.y;
    g.yz = a0.yz * x12.xz + h.yz * x12.yw;
    return 130.0 * dot(m, g);
}

void main()
{
  vec3 color = vec3(1.0);

  
  float surfaceWaterMix = smoothstep(-1.0, waterLevel, vPosition.y);
  color = mix(uColorWaterDeep, uColorWaterSurface, surfaceWaterMix);

  
  float sandMix = smoothstep(waterLevel, sandTop, vPosition.y);
  color = mix(color, uColorSand, sandMix);

  
  float groundMix = smoothstep(sandTop, grassTop, vPosition.y);
  float rockMix = abs(1.0 - dot(vec3(0.0, 1.0, 0.0), vNormalElevated));
  vec3 groundColor = mix(uColorGrass, uColorRock, step(0.3, rockMix));
  color = mix(color, groundColor, groundMix);

  
  
  float snowThreshold = snowCapStart + simplexNoise2d(vPosition.xz * 15.0) * 0.1;
  float snowCapMix = step(snowThreshold, vPosition.y);
  color = mix(color, uColorSnow, snowCapMix);

  csm_DiffuseColor = vec4(color, 1.0);
}`,xi=`uniform float uTime;
uniform float uPositionFrequency;
uniform float uStrength;
uniform float uWarpFrequency;
uniform float uWarpStrength;

varying vec2 vUv;
varying vec3 vPosition;
varying vec3 vNormalElevated;

vec3 permute(vec3 x) { return mod(((x*44.0)+1.0)*x, 299.0); }

float simplexNoise2d(vec2 v)
{
    const vec4 C = vec4(0.211324865405187, 0.366025403784439,
            -0.577350269189626, 0.024390243902439);
    vec2 i  = floor(v + dot(v, C.yy) );
    vec2 x0 = v -   i + dot(i, C.xx);
    vec2 i1;
    i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
    vec4 x12 = x0.xyxy + C.xxzz;
    x12.xy -= i1;
    i = mod(i, 299.0);
    vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
    + i.x + vec3(0.0, i1.x, 1.0 ));
    vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy),
    dot(x12.zw,x12.zw)), 0.0);
    m = m*m ;
    m = m*m ;
    vec3 x = 2.0 * fract(p * C.www) - 1.0;
    vec3 h = abs(x) - 0.5;
    vec3 ox = floor(x + 0.5);
    vec3 a0 = x - ox;
    m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );
    vec3 g;
    g.x  = a0.x  * x0.x  + h.x  * x0.y;
    g.yz = a0.yz * x12.xz + h.yz * x12.yw;
    return 130.0 * dot(m, g);
}

float getElevation(vec2 position) {
  vec2 warpedPosition = position;
  warpedPosition += uTime * 0.2;
  warpedPosition += simplexNoise2d(warpedPosition * uPositionFrequency * uWarpFrequency) * uWarpStrength;

  float elevation = 0.0;
  elevation += simplexNoise2d(warpedPosition * uPositionFrequency) / 2.0; 
  elevation += simplexNoise2d(warpedPosition * uPositionFrequency * 2.0) / 4.0; 
  elevation += simplexNoise2d(warpedPosition * uPositionFrequency * 4.0) / 8.0; 

  float elevationSign = sign(elevation);
  elevation = pow(abs(elevation), 2.0) * elevationSign;
  elevation *= uStrength;

  return elevation;
}

void main()
{
  
  float shift = 0.01;
  vec3 posA = position + vec3(shift, 0.0, 0.0);
  vec3 posB = position + vec3(0.0, 0.0, -shift);

  
  float elevation = getElevation(csm_Position.xz);
  csm_Position.y += elevation;
  posA.y = getElevation(posA.xz);
  posB.y = getElevation(posB.xz);

  
  vec3 toA = normalize(posA - csm_Position);
  vec3 toB = normalize(posB - csm_Position);
  csm_Normal = cross(toA, toB);

  vUv = uv;
  vPosition = csm_Position;
  vPosition.xz += uTime * 0.2;
  vNormalElevated = csm_Normal;
}`,Y=new ce({width:325}),X={colorWaterDeep:`#002b3d`,colorWaterSurface:`#66a8ff`,colorSand:`#ffe894`,colorGrass:`#85d534`,colorSnow:`#ffffff`,colorRock:`#bfbd8d`},Si=document.querySelector(`canvas.webgl`);if(!Si)throw Error(`No canvas`);var Ci=new ne,Z={uTime:new d(0),uPositionFrequency:new d(.2),uStrength:new d(2.5),uWarpFrequency:new d(7),uWarpStrength:new d(.2),uColorWaterDeep:new d(new oe(X.colorWaterDeep)),uColorWaterSurface:new d(new oe(X.colorWaterSurface)),uColorSand:new d(new oe(X.colorSand)),uColorGrass:new d(new oe(X.colorGrass)),uColorSnow:new d(new oe(X.colorSnow)),uColorRock:new d(new oe(X.colorRock))};Y.add(Z.uPositionFrequency,`value`,0,1,.001).name(`uPositionFrequency`),Y.add(Z.uStrength,`value`,0,10,.001).name(`uStrength`),Y.add(Z.uWarpFrequency,`value`,0,10,.001).name(`uWarpFrequency`),Y.add(Z.uWarpStrength,`value`,0,1,.001).name(`uWarpStrength`),Y.addColor(X,`colorWaterDeep`).onChange(e=>{Z.uColorWaterDeep.value.set(e)}),Y.addColor(X,`colorWaterSurface`).onChange(e=>{Z.uColorWaterSurface.value.set(e)}),Y.addColor(X,`colorSand`).onChange(e=>{Z.uColorSand.value.set(e)}),Y.addColor(X,`colorGrass`).onChange(e=>{Z.uColorGrass.value.set(e)}),Y.addColor(X,`colorSnow`).onChange(e=>{Z.uColorSnow.value.set(e)}),Y.addColor(X,`colorRock`).onChange(e=>{Z.uColorRock.value.set(e)});var wi=new u(10,10,500,500);wi.rotateX(-Math.PI*.5),wi.deleteAttribute(`uv`),wi.deleteAttribute(`normal`);var Ti=new le({baseMaterial:ae,fragmentShader:bi,vertexShader:xi,uniforms:Z,metalness:0,roughness:.5,color:`#85d534`}),Ei=new le({baseMaterial:h,vertexShader:xi,uniforms:Z,depthPacking:ee}),Di=new ie(wi,Ti);Di.customDepthMaterial=Ei,Di.receiveShadow=!0,Di.castShadow=!0,Ci.add(Di);var Oi=new ie(new u(10,10,1,1),new t({transmission:1,roughness:.3}));Oi.rotateX(-Math.PI*.5),Oi.position.y=-.05,Ci.add(Oi);var ki=new mr(new b(11,2,11)),Ai=new mr(new b(10,2,10)),ji=new yi().evaluate(ki,Ai,1);ji.castShadow=!0,ji.receiveShadow=!0,ji.geometry.clearGroups(),ji.material=new ae({color:`#ffffff`,metalness:0,roughness:.3}),ji.updateMatrixWorld(),Ci.add(ji);var Mi=new C(`#ffeaa4`,.4);Ci.add(Mi);var Q=new y(`#ffffff`,2);Q.position.set(6.25,3,4),Q.castShadow=!0,Q.shadow.mapSize.set(1024,1024),Q.shadow.camera.near=.1,Q.shadow.camera.far=30,Q.shadow.camera.top=8,Q.shadow.camera.right=8,Q.shadow.camera.bottom=-8,Q.shadow.camera.left=-8,Ci.add(Q);var $={width:window.innerWidth,height:window.innerHeight,pixelRatio:Math.min(window.devicePixelRatio,2)};window.addEventListener(`resize`,()=>{$.width=window.innerWidth,$.height=window.innerHeight,$.pixelRatio=Math.min(window.devicePixelRatio,2),Ni.aspect=$.width/$.height,Ni.updateProjectionMatrix(),Fi.setSize($.width,$.height),Fi.setPixelRatio($.pixelRatio)});var Ni=new a(35,$.width/$.height,.1,100);Ni.position.set(-15,8,10),Ci.add(Ni);var Pi=new se(Ni,Si);Pi.enableDamping=!0;var Fi=new x({canvas:Si,antialias:!0});Fi.shadowMap.enabled=!0,Fi.shadowMap.type=2,Fi.toneMapping=4,Fi.toneMappingExposure=1,Fi.setSize($.width,$.height),Fi.setPixelRatio($.pixelRatio);var Ii=new m,Li=()=>{let e=Ii.getElapsedTime();Z.uTime.value=e,Pi.update(),Fi.render(Ci,Ni),window.requestAnimationFrame(Li)};Li();